<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headcount Commander | Tech Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc, getDocs, query 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInWithPopup, signInAnonymously, GoogleAuthProvider, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDubfBijm6JyrwwRloqthvXCEHQV57Me2Y",
            authDomain: "tb-hiring-web.firebaseapp.com",
            databaseURL: "https://tb-hiring-web-default-rtdb.firebaseio.com",
            projectId: "tb-hiring-web",
            storageBucket: "tb-hiring-web.firebasestorage.app",
            messagingSenderId: "724670393100",
            appId: "1:724670393100:web:72e82f8404d052a6823729",
            measurementId: "G-CRDQYYGR45"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tb-hiring-web';

        // Application State
        let personnel = [];
        let tribes = [];
        let logs = [];
        let accessControl = { admins: [], viewers: [] };
        let config = {
            strategicGoal: 0,

            // ✅ NEW: Tribe Categories (synced from Firestore)
            categories: ["Unassigned", "Feature", "Platform", "Data"],
            
            // ✅ NEW: Excluded Tribes (treated like Resigned - hidden from all counts/ratios)
            excludedTribes: [],

            ratios: {
                pm: { min: 5, max: 8, label: "Eng : PM" },
                design: { min: 8, max: 12, label: "Eng : Design" },
                data: { min: 10, max: 15, label: "Eng : Data" }
            },
            compositions: {
                eng: { val: 65, label: "Eng" },
                prod: { val: 15, label: "PM" },
                design: { val: 12, label: "PD" },
                data: { val: 8, label: "Data & Insights" }
            },
            roles: ["Eng", "PM", "PD", "DS", "Data Engineering"],
            levels: ["IC1", "IC2", "IC3", "IC4", "IC5", "M1", "M2", "M3", "M4"],
            leadershipTitles: ["Tribe Lead", "Function Head", "Group Lead", "Lead"]
        };

        let activeTab = 'summary'; 
        let summaryCategory = 'All'; // Summary category filter
        let selectedRatioRoles = []; // Selected roles to display in ALL RATIOS section
        let viewContext = 'all'; 
        let managedSquadContext = { squad: null, tribe: null };
        let managedTribeContext = { name: null };
        let expandedTribes = [];
        let expandedSquads = [];
        let expandedFunctions = []; 
        let user = null;
        
        let chatMessages = []; // Store chat conversation history
        let isChatLoading = false; // Track if AI is responding
        
        let rosterFilters = { search: '', role: 'all', status: 'all', tribe: 'all', squad: 'all', sortBy: 'name', sortOrder: 'asc' };
        let squadManageFilters = { search: '', sortBy: 'name', sortOrder: 'asc' };
        let tribeManageFilters = { search: '', sortBy: 'name', sortOrder: 'asc' };
        let selectedRosterIds = new Set(); // Track selected personnel IDs for bulk actions

        // Firestore Access Helpers
        const getConfigDoc = () => doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
        const getTribesCol = () => collection(db, 'artifacts', appId, 'public', 'data', 'tribes');
        const getPersonnelCol = () => collection(db, 'artifacts', appId, 'public', 'data', 'personnel');
        const getLogsCol = () => collection(db, 'artifacts', appId, 'public', 'data', 'logs');

        // DOM Elements
        let loginScreen, appDashboard, emptyState, loadingOverlay, entryModal;

        const initDOMElements = () => {
            loginScreen = document.getElementById('login-screen');
            appDashboard = document.getElementById('app-dashboard');
            emptyState = document.getElementById('empty-state-setup');
            loadingOverlay = document.getElementById('loading-overlay');
            entryModal = document.getElementById('entry-modal');
        };

        const setLoading = (val) => {
            if (loadingOverlay) loadingOverlay.classList.toggle('hidden', !val);
        };

        // ✅ NEW: Sync/normalize tribe categories against config.categories
        window.normalizeTribeCategories = async ({ auto = false } = {}) => {
            if (!tribes?.length) return;

            const valid = new Set((config.categories || []).map(c => String(c).trim()).filter(Boolean));
            const fallback = valid.has("Unassigned") ? "Unassigned" : (config.categories?.[0] || "Unassigned");

            const toFix = tribes.filter(t => {
                const cat = (t.category ?? "").toString().trim();
                if (!cat) return true;
                if (!valid.has(cat)) return true;
                return false;
            });

            if (toFix.length === 0) return;

            if (!auto) {
                const msg =
                    `This will update ${toFix.length} tribe(s):\n` +
                    `- missing category → "${fallback}"\n` +
                    `- invalid category → "${fallback}"\n\nProceed?`;
                if (!confirm(msg)) return;
            }

            setLoading(true);
            try {
                for (const t of toFix) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', t.id), { category: fallback });
                }
            } catch (err) {
                console.error("Category normalization failed", err);
                if (!auto) alert("Failed to sync categories to tribes: " + err.message);
            } finally {
                setLoading(false);
            }
        };

        const initListeners = async () => {
            if (!user) return;
            try {
                const configSnap = await getDoc(getConfigDoc());
                if (!configSnap.exists()) {
                    emptyState.classList.remove('hidden');
                    appDashboard.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    appDashboard.classList.remove('hidden');
                }
            } catch (e) { console.error("Cold start check failed", e); }

            onSnapshot(getConfigDoc(), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    config = { 
                        ...config, 
                        ...data,
                        ratios: data.ratios || config.ratios,
                        compositions: data.compositions || config.compositions,
                        leadershipTitles: data.leadershipTitles || config.leadershipTitles,
                        categories: data.categories || config.categories
                    };
                    accessControl = {
                        admins: data.admins || [],
                        viewers: data.viewers || []
                    };
                    updateModalSelects();
                    refreshDashboard();

                    // ✅ Auto-fix tribes with missing/invalid categories (safe)
                    window.normalizeTribeCategories({ auto: true });
                }
            }, (err) => console.error("Config Sync Error", err));

            onSnapshot(getTribesCol(), (querySnap) => {
                tribes = querySnap.docs
                    .map(docu => ({ id: docu.id, category: 'Unassigned', order: 0, ...docu.data() }))
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                if (expandedTribes.length === 0 && tribes.length > 0) expandedTribes = [tribes[0].name];
                updateModalSelects();
                refreshDashboard();
            }, (err) => console.error("Tribe Sync Error", err));

            onSnapshot(getPersonnelCol(), (querySnap) => {
                personnel = querySnap.docs.map(docu => ({ id: docu.id, ...docu.data() }));
                refreshDashboard();
            }, (err) => console.error("Personnel Sync Error", err));

            onSnapshot(getLogsCol(), (querySnap) => {
                logs = querySnap.docs.map(docu => ({ id: docu.id, ...docu.data() }))
                    .sort((a, b) => {
                        const aTime = a.timestamp?.toDate?.() || new Date(0);
                        const bTime = b.timestamp?.toDate?.() || new Date(0);
                        return bTime - aTime;
                    });
                // Logs will be rendered as part of config view
                if (activeTab === 'config') renderConfig();
            }, (err) => console.error("Logs Sync Error", err));
        };

        // --- Global View Controls ---
        window.expandAllTribes = () => {
            expandedTribes = tribes.map(t => t.name);
            refreshDashboard();
        };

        window.collapseAllTribes = () => {
            expandedTribes = [];
            expandedSquads = [];
            refreshDashboard();
        };

        window.setSummaryCategory = (cat) => {
            summaryCategory = cat;
            refreshDashboard();
        };

        window.toggleRatioRole = (role) => {
            const index = selectedRatioRoles.indexOf(role);
            if (index !== -1) {
                selectedRatioRoles.splice(index, 1);
            } else {
                selectedRatioRoles.push(role);
            }
            refreshDashboard();
        };

        window.manageSquad = (squadName, tribeName) => {
            managedSquadContext = { squad: squadName, tribe: tribeName };
            activeTab = 'squad-manage';
            refreshDashboard();
        };

        window.manageTribe = (tribeName) => {
            managedTribeContext = { name: tribeName };
            activeTab = 'tribe-manage';
            refreshDashboard();
        };

        window.toggleFunctionDeepDive = (key) => {
            expandedFunctions = expandedFunctions.includes(key) 
                ? expandedFunctions.filter(f => f !== key) 
                : [...expandedFunctions, key];
            refreshDashboard();
        };

        // --- Log Helper ---
        const logChange = async (action, details) => {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    action: action,
                    details: details,
                    timestamp: new Date(),
                    user: user?.email || 'Anonymous'
                });
            } catch (err) {
                console.error("Logging failed", err);
            }
        };

        // --- Data Actions ---
        window.addNewHeadcount = async (formData) => {
            setLoading(true);
            try {
                const secondaryTribes = formData.secondaryTribes ? formData.secondaryTribes.split(',').map(t => t.trim()) : [];
                const newEntry = {
                    name: formData.name || "New Role",
                    role: formData.role || config.roles[0],
                    level: formData.level || "N/A",
                    tribe: formData.tribe || tribes[0]?.name || "Unassigned",
                    squad: formData.squad || tribes[0]?.squads[0] || "Unassigned",
                    status: formData.status || "Open",
                    leadershipTitle: formData.leadershipTitle || "",
                    secondaryTribes: secondaryTribes 
                };
                await addDoc(getPersonnelCol(), newEntry);
                await logChange('Added Headcount', `Added ${newEntry.name} as ${newEntry.role} (${newEntry.status}) to ${newEntry.tribe}/${newEntry.squad}`);
                closeEntryModal();
            } catch (err) { console.error(err); }
            setLoading(false);
        };

        window.updateMemberField = async (id, field, value) => {
            const person = personnel.find(p => p.id === id);
            const oldValue = person ? person[field] : 'N/A';
            const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'personnel', id);
            let updateData = { [field]: value };
            if (field === 'squad') {
                const parentTribe = tribes.find(t => t.squads.includes(value));
                if (parentTribe) updateData.tribe = parentTribe.name;
            }
            if (field === 'secondaryTribes') {
                updateData.secondaryTribes = value.split(',').map(t => t.trim()).filter(t => t);
            }
            await updateDoc(memberRef, updateData);
            await logChange('Updated Field', `Changed ${person?.name || 'person'}'s ${field} from "${oldValue}" to "${value}"`);
        };

        window.updateTribeField = async (id, field, value) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', id), { [field]: value });
        };

        window.deleteHeadcount = async (id) => {
            if (!confirm("Permanent deletion?")) return;
            const person = personnel.find(p => p.id === id);
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', id));
            await logChange('Deleted Headcount', `Deleted ${person?.name || 'person'} (${person?.role || 'N/A'}) from ${person?.tribe || 'N/A'}/${person?.squad || 'N/A'}`);
        };

        window.handleDragStart = (e, memberId) => {
            e.dataTransfer.setData("memberId", memberId);
            e.target.classList.add('opacity-40');
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('opacity-40');
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            const targetCard = e.currentTarget;
            targetCard.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-4');
        };

        window.handleDragLeave = (e) => {
            e.currentTarget.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-4');
        };

        window.handleDrop = async (e, targetSquadName, targetTribeName) => {
            e.preventDefault();
            e.currentTarget.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-4');
            const memberId = e.dataTransfer.getData("memberId");
            if (memberId) {
                const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'personnel', memberId);
                await updateDoc(memberRef, {
                    squad: targetSquadName,
                    tribe: targetTribeName
                });
            }
        };

        window.addTribe = async () => {
            const name = prompt("Enter new Tribe name:");
            if (!name) return;

            const valid = new Set((config.categories || []).map(c => String(c).trim()).filter(Boolean));
            const fallback = valid.has("Unassigned") ? "Unassigned" : (config.categories?.[0] || "Unassigned");

            await addDoc(getTribesCol(), { name, squads: [], category: fallback, order: tribes.length });
        };

        window.moveTribeUp = async (tribeId) => {
            const tribeIndex = tribes.findIndex(t => t.id === tribeId);
            if (tribeIndex <= 0) return; // Already at top
            
            setLoading(true);
            try {
                // Swap order with previous tribe
                const currentTribe = tribes[tribeIndex];
                const previousTribe = tribes[tribeIndex - 1];
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', currentTribe.id), { order: tribeIndex - 1 });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', previousTribe.id), { order: tribeIndex });
                
                await logChange('Organization', `Moved tribe "${currentTribe.name}" up`);
            } catch (err) { console.error(err); }
            setLoading(false);
        };

        window.moveTribeDown = async (tribeId) => {
            const tribeIndex = tribes.findIndex(t => t.id === tribeId);
            if (tribeIndex < 0 || tribeIndex >= tribes.length - 1) return; // Already at bottom
            
            setLoading(true);
            try {
                // Swap order with next tribe
                const currentTribe = tribes[tribeIndex];
                const nextTribe = tribes[tribeIndex + 1];
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', currentTribe.id), { order: tribeIndex + 1 });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', nextTribe.id), { order: tribeIndex });
                
                await logChange('Organization', `Moved tribe "${currentTribe.name}" down`);
            } catch (err) { console.error(err); }
            setLoading(false);
        };

        window.moveSquadUpInTribe = async (tribeId, squadName) => {
            const tribe = tribes.find(t => t.id === tribeId);
            if (!tribe || !tribe.squads) return;
            
            const squadIndex = tribe.squads.indexOf(squadName);
            if (squadIndex <= 0) return; // Already at top
            
            setLoading(true);
            try {
                const newSquads = [...tribe.squads];
                // Swap with previous squad
                [newSquads[squadIndex - 1], newSquads[squadIndex]] = [newSquads[squadIndex], newSquads[squadIndex - 1]];
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', tribeId), { squads: newSquads });
                await logChange('Organization', `Moved squad "${squadName}" up in ${tribe.name}`);
            } catch (err) { console.error(err); }
            setLoading(false);
        };

        window.moveSquadDownInTribe = async (tribeId, squadName) => {
            const tribe = tribes.find(t => t.id === tribeId);
            if (!tribe || !tribe.squads) return;
            
            const squadIndex = tribe.squads.indexOf(squadName);
            if (squadIndex < 0 || squadIndex >= tribe.squads.length - 1) return; // Already at bottom
            
            setLoading(true);
            try {
                const newSquads = [...tribe.squads];
                // Swap with next squad
                [newSquads[squadIndex], newSquads[squadIndex + 1]] = [newSquads[squadIndex + 1], newSquads[squadIndex]];
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', tribeId), { squads: newSquads });
                await logChange('Organization', `Moved squad "${squadName}" down in ${tribe.name}`);
            } catch (err) { console.error(err); }
            setLoading(false);
        };

        window.deleteTribe = async (id) => {
            if (confirm("Delete tribe and all squad links?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', id));
            }
        };

        window.addSquad = async (tribeId, existingSquads) => {
            const name = prompt("Enter new Squad name:");
            if (name) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', tribeId), {
                    squads: [...existingSquads, name]
                });
            }
        };

        window.deleteSquad = async (tribeId, squadName, existingSquads) => {
            if (confirm(`Remove squad "${squadName}"?`)) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', tribeId), {
                    squads: existingSquads.filter(s => s !== squadName)
                });
            }
        };

        window.updateTribeName = async (id, oldName, newName) => {
            if (!newName || oldName === newName) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', id), { name: newName });
                const affected = personnel.filter(p => p.tribe === oldName);
                for (const p of affected) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', p.id), { tribe: newName });
                }
                if (expandedTribes.includes(oldName)) {
                    expandedTribes = expandedTribes.map(t => t === oldName ? newName : t);
                }
            } catch (err) { console.error("Rename Tribe Failed", err); }
        };

        window.updateSquadName = async (tribeId, tribeName, oldSq, newSq, allSq) => {
            if (!newSq || oldSq === newSq) return;
            try {
                const newSquads = allSq.map(s => s === oldSq ? newSq : s);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', tribeId), { squads: newSquads });
                const affected = personnel.filter(p => p.tribe === tribeName && p.squad === oldSq);
                for (const p of affected) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', p.id), { squad: newSq });
                }
                if (expandedSquads.includes(oldSq)) {
                    expandedSquads = expandedSquads.map(s => s === oldSq ? newSq : s);
                }
            } catch (err) { console.error("Rename Squad Failed", err); }
        };

        window.moveSquad = async (sourceTribeId, sourceTribeName, squadName, sourceSquads) => {
            const otherTribes = tribes.filter(t => t.id !== sourceTribeId);
            if (otherTribes.length === 0) {
                alert("No other tribes available to move to.");
                return;
            }
            const tribeNames = otherTribes.map((t, i) => `${i + 1}. ${t.name}`).join('\n');
            const choice = prompt(`Move "${squadName}" to which tribe?\n\n${tribeNames}\n\nEnter the number:`);
            if (choice) {
                const index = parseInt(choice) - 1;
                if (otherTribes[index]) {
                    const targetTribe = otherTribes[index];
                    setLoading(true);
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', sourceTribeId), {
                            squads: sourceSquads.filter(s => s !== squadName)
                        });
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tribes', targetTribe.id), {
                            squads: [...targetTribe.squads, squadName]
                        });
                        const affected = personnel.filter(p => p.tribe === sourceTribeName && p.squad === squadName);
                        for (const p of affected) {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', p.id), { 
                                tribe: targetTribe.name 
                            });
                        }
                    } catch (err) { console.error("Move Squad Failed", err); }
                    setLoading(false);
                }
            }
        };

        window.addConfigItem = async (key) => {
            const val = prompt(`Add new ${key.slice(0, -1)}:`);
            if (val) {
                const newList = [...(config[key] || []), val];
                await setDoc(getConfigDoc(), { [key]: newList }, { merge: true });
            }
        };

        window.removeConfigItem = async (key, val) => {
            if (confirm(`Remove ${val}?`)) {
                const newList = (config[key] || []).filter(v => v !== val);
                await setDoc(getConfigDoc(), { [key]: newList }, { merge: true });
            }
        };

        window.updateConfig = async (key, val) => {
            let parsedVal = isNaN(val) || val === '' ? val : parseFloat(val);
            config[key] = parsedVal;
            await setDoc(getConfigDoc(), config, { merge: true });
        };

        window.updateNestedConfig = async (parent, key, field, val) => {
            let parsedVal = isNaN(val) || val === '' ? val : parseFloat(val);
            config[parent][key][field] = parsedVal;
            await setDoc(getConfigDoc(), config, { merge: true });
        };

        // Toggle tribe in/out of excluded list
        window.toggleExcludedTribe = async (tribeName) => {
            if (!tribeName) return;
            
            const excludedTribes = config.excludedTribes || [];
            const index = excludedTribes.indexOf(tribeName);
            
            if (index !== -1) {
                // Remove from excluded
                excludedTribes.splice(index, 1);
                await logChange('Config', `Tribe "${tribeName}" included in counts/ratios`);
            } else {
                // Add to excluded
                excludedTribes.push(tribeName);
                await logChange('Config', `Tribe "${tribeName}" excluded from counts/ratios`);
            }
            
            config.excludedTribes = excludedTribes;
            await setDoc(getConfigDoc(), { excludedTribes }, { merge: true });
        };

        // Access Control Functions
        window.addAdmin = async () => {
            const email = prompt("Enter admin email address:");
            if (!email || !email.includes('@')) {
                alert("Please enter a valid email address");
                return;
            }
            if (accessControl.admins.includes(email)) {
                alert("This email is already an admin");
                return;
            }
            const newAdmins = [...accessControl.admins, email];
            await setDoc(getConfigDoc(), { admins: newAdmins }, { merge: true });
            await logChange('Access Control', `Added admin: ${email}`);
        };

        window.removeAdmin = async (email) => {
            if (!confirm(`Remove admin access for ${email}?`)) return;
            const newAdmins = accessControl.admins.filter(e => e !== email);
            await setDoc(getConfigDoc(), { admins: newAdmins }, { merge: true });
            await logChange('Access Control', `Removed admin: ${email}`);
        };

        window.addViewer = async () => {
            const email = prompt("Enter viewer email address:");
            if (!email || !email.includes('@')) {
                alert("Please enter a valid email address");
                return;
            }
            if (accessControl.viewers.includes(email)) {
                alert("This email is already a viewer");
                return;
            }
            if (accessControl.admins.includes(email)) {
                alert("This email is already an admin (has full access)");
                return;
            }
            const newViewers = [...accessControl.viewers, email];
            await setDoc(getConfigDoc(), { viewers: newViewers }, { merge: true });
            await logChange('Access Control', `Added viewer: ${email}`);
        };

        window.removeViewer = async (email) => {
            if (!confirm(`Remove viewer access for ${email}?`)) return;
            const newViewers = accessControl.viewers.filter(e => e !== email);
            await setDoc(getConfigDoc(), { viewers: newViewers }, { merge: true });
            await logChange('Access Control', `Removed viewer: ${email}`);
        };

        window.promoteToAdmin = async (email) => {
            if (!confirm(`Promote ${email} to admin?`)) return;
            const newViewers = accessControl.viewers.filter(e => e !== email);
            const newAdmins = [...accessControl.admins, email];
            await setDoc(getConfigDoc(), { viewers: newViewers, admins: newAdmins }, { merge: true });
            await logChange('Access Control', `Promoted ${email} to admin`);
        };

        // --- View Logic ---
        window.setTab = (tab) => {
            activeTab = tab;
            refreshDashboard();
        };

        window.setViewContext = (context) => {
            viewContext = context;
            refreshDashboard();
        };

        window.toggleTribe = (name) => {
            expandedTribes = expandedTribes.includes(name) ? expandedTribes.filter(t => t !== name) : [...expandedTribes, name];
            refreshDashboard();
        };

        window.toggleSquadExpand = (name) => {
            expandedSquads = expandedSquads.includes(name) ? expandedSquads.filter(s => s !== name) : [...expandedSquads, name];
            refreshDashboard();
        };

        // Debounce timers for search inputs
        let rosterSearchTimeout;
        let squadSearchTimeout;
        let tribeSearchTimeout;

        window.updateRosterFilter = (key, val) => {
            rosterFilters[key] = val;
            
            // Debounce search input, but not dropdowns
            if (key === 'search') {
                clearTimeout(rosterSearchTimeout);
                rosterSearchTimeout = setTimeout(() => {
                    renderRoster();
                }, 300); // 300ms delay
            } else {
                renderRoster();
            }
        };

        window.toggleRosterSort = () => {
            rosterFilters.sortOrder = rosterFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            const icon = document.getElementById('roster-sort-icon');
            if (icon) {
                icon.className = rosterFilters.sortOrder === 'asc' ? 'fa-solid fa-arrow-down-a-z text-sm' : 'fa-solid fa-arrow-up-z-a text-sm';
            }
            renderRoster();
        };

        window.updateSquadManageFilter = (key, val) => {
            squadManageFilters[key] = val;
            
            // Debounce search input
            if (key === 'search') {
                clearTimeout(squadSearchTimeout);
                squadSearchTimeout = setTimeout(() => {
                    renderSquadManage();
                }, 300);
            } else {
                renderSquadManage();
            }
        };

        window.toggleSquadManageSort = () => {
            squadManageFilters.sortOrder = squadManageFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            const icon = document.getElementById('squad-sort-icon');
            if (icon) {
                icon.className = squadManageFilters.sortOrder === 'asc' ? 'fa-solid fa-arrow-down-a-z text-sm' : 'fa-solid fa-arrow-up-z-a text-sm';
            }
            renderSquadManage();
        };

        window.updateTribeManageFilter = (key, val) => {
            tribeManageFilters[key] = val;
            
            // Debounce search input
            if (key === 'search') {
                clearTimeout(tribeSearchTimeout);
                tribeSearchTimeout = setTimeout(() => {
                    renderTribeManage();
                }, 300);
            } else {
                renderTribeManage();
            }
        };

        window.toggleTribeManageSort = () => {
            tribeManageFilters.sortOrder = tribeManageFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            const icon = document.getElementById('tribe-sort-icon');
            if (icon) {
                icon.className = tribeManageFilters.sortOrder === 'asc' ? 'fa-solid fa-arrow-down-a-z text-sm' : 'fa-solid fa-arrow-up-z-a text-sm';
            }
            renderTribeManage();
        };

        // Bulk action functions
        window.toggleRosterSelection = (id) => {
            if (selectedRosterIds.has(id)) {
                selectedRosterIds.delete(id);
            } else {
                selectedRosterIds.add(id);
            }
            renderRoster();
        };

        window.toggleAllRosterSelection = () => {
            const visiblePersonnel = getFilteredRosterPersonnel();
            if (selectedRosterIds.size === visiblePersonnel.length) {
                selectedRosterIds.clear();
            } else {
                selectedRosterIds.clear();
                visiblePersonnel.forEach(p => selectedRosterIds.add(p.id));
            }
            renderRoster();
        };

        window.clearRosterSelection = () => {
            selectedRosterIds.clear();
            renderRoster();
        };

        window.applyBulkUpdate = async (field, value) => {
            if (selectedRosterIds.size === 0) {
                alert('No people selected. Please select people using the checkboxes.');
                return;
            }

            const count = selectedRosterIds.size;
            const confirmation = confirm(`Update ${field} to "${value}" for ${count} selected ${count === 1 ? 'person' : 'people'}?`);
            
            if (!confirmation) return;

            setLoading(true);
            try {
                const updates = Array.from(selectedRosterIds).map(async (id) => {
                    const updateData = {};
                    
                    if (field === 'tribe') {
                        updateData.tribe = value;
                        // Reset squad when changing tribe
                        const newTribe = tribes.find(t => t.name === value);
                        updateData.squad = newTribe?.squads?.[0] || 'Unassigned';
                    } else if (field === 'squad') {
                        updateData.squad = value;
                    } else {
                        updateData[field] = value;
                    }

                    return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', id), updateData);
                });

                await Promise.all(updates);
                await logChange('Bulk Update', `Updated ${field} to "${value}" for ${count} ${count === 1 ? 'person' : 'people'}`);
                
                selectedRosterIds.clear();
            } catch (err) {
                console.error(err);
                alert('Failed to apply bulk update: ' + err.message);
            }
            setLoading(false);
        };

        const getFilteredRosterPersonnel = () => {
            let filtered = personnel.filter(p => {
                const searchTerm = rosterFilters.search.toLowerCase();
                const matchSearch = 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.tribe || '').toLowerCase().includes(searchTerm) ||
                    (p.squad || '').toLowerCase().includes(searchTerm) ||
                    (p.role || '').toLowerCase().includes(searchTerm) ||
                    (p.leadershipTitle || '').toLowerCase().includes(searchTerm);
                
                const matchRole = rosterFilters.role === 'all' || p.role === rosterFilters.role;
                const matchStatus = rosterFilters.status === 'all' || p.status === rosterFilters.status;
                const matchTribe = rosterFilters.tribe === 'all' || p.tribe === rosterFilters.tribe;
                const matchSquad = rosterFilters.squad === 'all' || p.squad === rosterFilters.squad;
                
                return matchSearch && matchRole && matchStatus && matchTribe && matchSquad;
            });

            // Apply sorting
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch(rosterFilters.sortBy) {
                    case 'name': aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase(); break;
                    case 'role': aVal = (a.role || '').toLowerCase(); bVal = (b.role || '').toLowerCase(); break;
                    case 'tribe': aVal = (a.tribe || '').toLowerCase(); bVal = (b.tribe || '').toLowerCase(); break;
                    case 'squad': aVal = (a.squad || '').toLowerCase(); bVal = (b.squad || '').toLowerCase(); break;
                    case 'status': aVal = (a.status || '').toLowerCase(); bVal = (b.status || '').toLowerCase(); break;
                    default: aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase();
                }
                
                if (rosterFilters.sortOrder === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            return filtered;
        };

        window.openEntryModal = (prefillTribe = null, prefillSquad = null) => {
            updateModalSelects();
            
            // If tribe/squad are provided, pre-select them
            if (prefillTribe) {
                const tribeSelect = document.getElementById('entry-tribe');
                if (tribeSelect) {
                    tribeSelect.value = prefillTribe;
                    // Trigger change to update squads dropdown
                    tribeSelect.dispatchEvent(new Event('change'));
                    
                    // Set squad after a brief delay to ensure squads are populated
                    if (prefillSquad) {
                        setTimeout(() => {
                            const squadSelect = document.getElementById('entry-squad');
                            if (squadSelect) {
                                squadSelect.value = prefillSquad;
                            }
                        }, 50);
                    }
                }
            }
            
            entryModal.classList.remove('hidden');
        };
        window.closeEntryModal = () => entryModal.classList.add('hidden');

        // NEW: Roster Edit Modal
        window.openRosterEditModal = (id) => {
            const person = personnel.find(p => p.id === id);
            if (!person) return;
            
            const modal = document.getElementById('roster-edit-modal');
            if (!modal) return;
            
            document.getElementById('edit-person-id').value = id;
            document.getElementById('edit-person-name').value = person.name || '';
            
            // Populate and select role dropdown
            const roleSelect = document.getElementById('edit-person-role');
            roleSelect.innerHTML = config.roles.map(r => `<option value="${r}">${r}</option>`).join('');
            roleSelect.value = person.role || config.roles[0];
            
            // Populate and select level dropdown
            const levelSelect = document.getElementById('edit-person-level');
            levelSelect.innerHTML = `<option value="">N/A</option>` + config.levels.map(l => `<option value="${l}">${l}</option>`).join('');
            levelSelect.value = person.level || '';
            
            // Populate and select tribe dropdown
            const tribeSelect = document.getElementById('edit-person-tribe');
            tribeSelect.innerHTML = tribes.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            tribeSelect.value = person.tribe || tribes[0]?.name || '';
            
            // Update squad dropdown based on tribe
            const tribe = tribes.find(t => t.name === person.tribe);
            const squadSelect = document.getElementById('edit-person-squad');
            squadSelect.innerHTML = (tribe?.squads || []).map(s => `<option value="${s}">${s}</option>`).join('');
            squadSelect.value = person.squad || (tribe?.squads?.[0] || '');
            
            document.getElementById('edit-person-status').value = person.status || 'Open';
            document.getElementById('edit-person-leadership').value = person.leadershipTitle || '';
            
            // Populate and select secondary tribes (multi-select)
            const secondarySelect = document.getElementById('edit-person-secondary');
            const currentTribe = person.tribe;
            const secondaryTribes = person.secondaryTribes || [];
            
            // Show all tribes except the primary one
            secondarySelect.innerHTML = tribes
                .filter(t => t.name !== currentTribe)
                .map(t => `<option value="${t.name}" ${secondaryTribes.includes(t.name) ? 'selected' : ''}>${t.name}</option>`)
                .join('');
            
            modal.classList.remove('hidden');
        };

        window.closeRosterEditModal = () => {
            const modal = document.getElementById('roster-edit-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.saveRosterEdit = async () => {
            const id = document.getElementById('edit-person-id').value;
            const status = document.getElementById('edit-person-status').value;
            const person = personnel.find(p => p.id === id);
            
            // Get selected secondary tribes from multi-select
            const secondarySelect = document.getElementById('edit-person-secondary');
            const selectedSecondary = Array.from(secondarySelect.selectedOptions).map(option => option.value);
            
            const updates = {
                name: document.getElementById('edit-person-name').value,
                role: document.getElementById('edit-person-role').value,
                level: document.getElementById('edit-person-level').value,
                tribe: status === 'Resigned' ? 'Resigned' : document.getElementById('edit-person-tribe').value,
                squad: status === 'Resigned' ? 'Resigned' : document.getElementById('edit-person-squad').value,
                status: status,
                leadershipTitle: document.getElementById('edit-person-leadership').value,
                secondaryTribes: selectedSecondary
            };
            
            // Track date changes for Hired and Resigned status
            if (status === 'Hired' && person?.status !== 'Hired') {
                updates.hiredDate = new Date().toISOString();
            }
            if (status === 'Resigned' && person?.status !== 'Resigned') {
                updates.resignedDate = new Date().toISOString();
            }
            
            setLoading(true);
            try {
                // Ensure Resigned tribe exists
                if (status === 'Resigned') {
                    const resignedTribe = tribes.find(t => t.name === 'Resigned');
                    if (!resignedTribe) {
                        await addDoc(getTribesCol(), { name: 'Resigned', squads: ['Resigned'], category: 'Unassigned' });
                    }
                }
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', id), updates);
                
                // Log the change
                const changes = [];
                if (person?.name !== updates.name) changes.push(`name to "${updates.name}"`);
                if (person?.role !== updates.role) changes.push(`role to ${updates.role}`);
                if (person?.status !== updates.status) changes.push(`status to ${updates.status}`);
                if (person?.tribe !== updates.tribe) changes.push(`tribe to ${updates.tribe}`);
                if (person?.squad !== updates.squad) changes.push(`squad to ${updates.squad}`);
                if (changes.length > 0) {
                    await logChange('Updated Person', `Updated ${person?.name || 'person'}: ${changes.join(', ')}`);
                }
                
                window.closeRosterEditModal();
            } catch (err) {
                console.error("Update failed", err);
                alert("Failed to update: " + err.message);
            }
            setLoading(false);
        };

        window.deleteRosterEntry = async () => {
            if (!confirm("Permanent deletion?")) return;
            const id = document.getElementById('edit-person-id').value;
            setLoading(true);
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personnel', id));
                window.closeRosterEditModal();
            } catch (err) {
                console.error("Delete failed", err);
                alert("Failed to delete: " + err.message);
            }
            setLoading(false);
        };

        // Update squad options when tribe changes in edit modal
        window.updateEditSquadOptions = (tribeName) => {
            const tribe = tribes.find(t => t.name === tribeName);
            const squadSelect = document.getElementById('edit-person-squad');
            if (squadSelect) {
                squadSelect.innerHTML = (tribe?.squads || []).map(s => `<option value="${s}">${s}</option>`).join('');
            }
        };

        // --- CSV Engine ---
        window.handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => await processCSV(e.target.result);
            reader.readAsText(file);
        };

        // Export to Excel function
        window.exportToExcel = async () => {
            setLoading(true);
            try {
                // We'll use SheetJS (xlsx) library
                const XLSX = await import('https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs');
                
                const workbook = XLSX.utils.book_new();
                
                // Create summary sheet FIRST
                const summaryData = [
                    ['Tribe Summary Report'],
                    ['Generated', new Date().toLocaleString()],
                    [],
                    ['Tribe', 'Total Headcount', 'Hired', 'Open', 'Hiring', 'Fill Rate']
                ];
                
                tribes.forEach(tribe => {
                    const tribePersonnel = personnel.filter(p => p.tribe === tribe.name && p.status !== 'Resigned');
                    const hired = tribePersonnel.filter(p => p.status === 'Hired').length;
                    const open = tribePersonnel.filter(p => p.status === 'Open').length;
                    const hiring = tribePersonnel.filter(p => p.status === 'Hiring').length;
                    const fillRate = tribePersonnel.length > 0 ? Math.round((hired / tribePersonnel.length) * 100) : 0;
                    
                    summaryData.push([
                        tribe.name,
                        tribePersonnel.length,
                        hired,
                        open,
                        hiring,
                        `${fillRate}%`
                    ]);
                });
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                summarySheet['!cols'] = [
                    { wch: 25 },
                    { wch: 18 },
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 12 }
                ];
                
                // Add summary sheet FIRST
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                // Then create a sheet for each tribe
                tribes.forEach(tribe => {
                    const tribePersonnel = personnel.filter(p => p.tribe === tribe.name && p.status !== 'Resigned');
                    
                    if (tribePersonnel.length === 0) return; // Skip empty tribes
                    
                    // Get all unique squads for this tribe
                    const squads = tribe.squads || [];
                    
                    // Get all unique roles
                    const roles = [...new Set(tribePersonnel.map(p => p.role))].sort();
                    
                    // Create header row
                    const headers = ['Squad', ...squads];
                    
                    // Create data rows - one row per role
                    const data = [headers];
                    
                    roles.forEach(role => {
                        const row = [role];
                        
                        squads.forEach(squad => {
                            // Get all people with this role in this squad
                            const people = tribePersonnel.filter(p => 
                                p.squad === squad && p.role === role
                            );
                            
                            if (people.length === 0) {
                                row.push('');
                            } else {
                                // Join multiple people with line breaks
                                const names = people.map(p => {
                                    let name = p.name || 'Unnamed';
                                    if (p.status === 'Open' || p.status === 'Hiring') {
                                        name = `Open: ${p.role}`;
                                    }
                                    return name;
                                }).join('\n');
                                row.push(names);
                            }
                        });
                        
                        data.push(row);
                    });
                    
                    // Add empty row for spacing
                    data.push([]);
                    
                    // Add TOTAL FTE row
                    const totalRow = ['TOTAL FTEs'];
                    squads.forEach(squad => {
                        const squadCount = tribePersonnel.filter(p => p.squad === squad && p.status === 'Hired').length;
                        totalRow.push(squadCount);
                    });
                    data.push(totalRow);
                    
                    // Add overall tribe total
                    data.push([]);
                    const tribeTotalHired = tribePersonnel.filter(p => p.status === 'Hired').length;
                    const tribeTotalAll = tribePersonnel.length;
                    data.push([`${tribe.name} Total:`, `${tribeTotalHired} Hired / ${tribeTotalAll} Total`]);
                    
                    // Create worksheet from data
                    const worksheet = XLSX.utils.aoa_to_sheet(data);
                    
                    // Set column widths
                    const colWidths = [{ wch: 20 }]; // First column (role names)
                    squads.forEach(() => colWidths.push({ wch: 18 })); // Squad columns
                    worksheet['!cols'] = colWidths;
                    
                    // Set row heights for wrapped text
                    worksheet['!rows'] = data.map((row, idx) => {
                        // Regular data rows get taller height for wrapped text
                        if (idx === 0) return { hpt: 20 }; // Header
                        if (idx > roles.length && idx < data.length - 2) return { hpt: 25 }; // Total rows
                        return { hpt: 60 }; // Data rows
                    });
                    
                    // Style header row
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!worksheet[cellRef]) continue;
                        worksheet[cellRef].s = {
                            font: { bold: true, sz: 12 },
                            fill: { fgColor: { rgb: "E2E8F0" } },
                            alignment: { horizontal: 'center', vertical: 'center' }
                        };
                    }
                    
                    // Style TOTAL FTE row (bold with background)
                    const totalRowIndex = roles.length + 2; // After roles and empty row
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: totalRowIndex, c: col });
                        if (!worksheet[cellRef]) continue;
                        worksheet[cellRef].s = {
                            font: { bold: true, sz: 11 },
                            fill: { fgColor: { rgb: "FEF3C7" } }, // Light yellow
                            alignment: { horizontal: 'center', vertical: 'center' }
                        };
                    }
                    
                    // Style tribe total row (bold)
                    const tribeTotalRowIndex = totalRowIndex + 2;
                    for (let col = range.s.c; col <= Math.min(range.s.c + 1, range.e.c); col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: tribeTotalRowIndex, c: col });
                        if (!worksheet[cellRef]) continue;
                        worksheet[cellRef].s = {
                            font: { bold: true, sz: 11 },
                            fill: { fgColor: { rgb: "DBEAFE" } }, // Light blue
                            alignment: { horizontal: 'left', vertical: 'center' }
                        };
                    }
                    
                    // Add worksheet to workbook with tribe name (limit to 31 chars for Excel)
                    const sheetName = tribe.name.substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                });
                
                // Generate Excel file and download
                const fileName = `Headcount_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                await logChange('Export', `Exported data to Excel: ${fileName}`);
                
            } catch (err) {
                console.error("Export failed", err);
                alert("Failed to export: " + err.message);
            }
            setLoading(false);
        };

        const processCSV = async (csvText) => {
            setLoading(true);
            try {
                const lines = csvText.split(/\r?\n/);
                let currentSection = "";
                const settingsData = [], rolesData = [];
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    if (line === "[SETTINGS]") { currentSection = "settings"; continue; }
                    if (line === "[ROLES]") { currentSection = "roles"; continue; }
                    if (currentSection === "settings") settingsData.push(line.split(","));
                    if (currentSection === "roles") rolesData.push(line.split(","));
                }
                let totalGoal = 0;
                settingsData.slice(1).forEach(row => {
                    const val = parseInt(row[1]);
                    if (!isNaN(val)) totalGoal += val;
                });
                const header = rolesData[0];
                const rawPeople = rolesData.slice(1).map(row => {
                    const obj = {};
                    header.forEach((h, i) => obj[h] = row[i]);
                    return obj;
                });
                const rolesSet = new Set(), levelsSet = new Set(), tribeMap = {};
                rawPeople.forEach(p => {
                    if (p.Function) rolesSet.add(p.Function);
                    if (p.Seniority) levelsSet.add(p.Seniority);
                    if (p.TribeName) {
                        if (!tribeMap[p.TribeName]) tribeMap[p.TribeName] = new Set();
                        if (p.SquadName) tribeMap[p.TribeName].add(p.SquadName);
                    }
                });
                await setDoc(getConfigDoc(), {
                    ...config,
                    strategicGoal: totalGoal,
                    roles: Array.from(rolesSet),
                    levels: Array.from(levelsSet).sort()
                });
                for (const [name, squads] of Object.entries(tribeMap)) {
                    await addDoc(getTribesCol(), { name, squads: Array.from(squads), category: 'Unassigned' });
                }
                for (const p of rawPeople) {
                    if (!p.Name) continue;
                    await addDoc(getPersonnelCol(), {
                        name: p.Name,
                        role: p.Function || "Unassigned",
                        level: p.Seniority || "N/A",
                        tribe: p.TribeName || "N/A",
                        squad: p.SquadName || "N/A",
                        status: p.Status === "filled" ? "Hired" : (p.Status === "open" ? "Hiring" : "Open"),
                        leadershipTitle: "",
                        secondaryTribes: []
                    });
                }
                emptyState.classList.add('hidden');
                appDashboard.classList.remove('hidden');
                setLoading(false);
            } catch (err) {
                console.error(err);
                alert("Processing failed: " + err.message);
                setLoading(false);
            }
        };

        // --- Render Helpers ---
        
        // Filter out excluded tribes (treats them like resigned - hidden from counts/ratios)
        const filterActivePersonnel = (list) => {
            return list.filter(p => {
                // Exclude resigned
                if (p.status === 'Resigned') return false;
                // Exclude if in excluded tribes list
                if (config.excludedTribes && config.excludedTribes.includes(p.tribe)) return false;
                return true;
            });
        };
        
        const getFunctionKey = (role) => {
            const r = role.toLowerCase();
            if (r.includes('eng') && !r.includes('data')) return 'eng';
            if (r.includes('prod') && r.includes('manage')) return 'prod'; // Product Management (legacy)
            if (r === 'pm') return 'prod'; // PM (new)
            if (r.includes('prod') && r.includes('design')) return 'design'; // Product Design (legacy)
            if (r === 'pd') return 'design'; // PD (new)
            if (r.includes('data') && r.includes('science')) return 'data'; // Data Science (legacy)
            if (r === 'ds') return 'data'; // DS (new)
            if (r.includes('data')) return 'data';
            return 'other';
        };

        const getRoleCounts = (list) => {
            const pm = list.filter(p => getFunctionKey(p.role) === 'prod').length;
            const pd = list.filter(p => getFunctionKey(p.role) === 'design').length;
            const eng = list.filter(p => getFunctionKey(p.role) === 'eng').length;
            const da = list.filter(p => getFunctionKey(p.role) === 'data').length;
            return { pm, pd, eng, da };
        };

        const getLeverageRatios = (list) => {
            const r = getRoleCounts(list);
            return {
                engPm: r.pm > 0 ? (r.eng / r.pm).toFixed(1) : (r.eng > 0 ? '∞' : '0'),
                engPd: r.pd > 0 ? (r.eng / r.pd).toFixed(1) : (r.eng > 0 ? '∞' : '0'),
                engDa: r.da > 0 ? (r.eng / r.da).toFixed(1) : (r.eng > 0 ? '∞' : '0')
            };
        };

        const getManagerRatio = (list) => {
            const managers = list.filter(p => p.level && p.level.toUpperCase().startsWith('M')).length;
            const ics = list.filter(p => !p.level || !p.level.toUpperCase().startsWith('M')).length;
            return {
                managers,
                ics,
                ratio: managers > 0 ? (ics / managers).toFixed(1) : (ics > 0 ? '∞' : '0'),
                total: managers + ics
            };
        };

        const getRoleAbbr = (role) => {
            const r = role.toLowerCase();
            if (r.includes('eng') && !r.includes('data')) return 'Eng';
            if (r.includes('prod') && r.includes('manage')) return 'PM'; // Product Management (legacy)
            if (r === 'pm') return 'PM'; // PM (new)
            if (r.includes('prod') && r.includes('design')) return 'PD'; // Product Design (legacy)
            if (r === 'pd') return 'PD'; // PD (new)
            if (r.includes('data') && r.includes('science')) return 'DS'; // Data Science (legacy)
            if (r === 'ds') return 'DS'; // DS (new)
            if (r.includes('data')) return 'DA';
            return 'Other';
        };

        const formatCountsTag = (list) => {
            const c = getRoleCounts(list);
            const baseClass = "bg-slate-50 border border-slate-100 text-slate-400 px-2 py-0.5 rounded-md font-black";
            return `
                <div class="flex items-center gap-1.5 font-black text-[9px] uppercase tracking-tighter">
                    <span class="${baseClass}">${c.pm}PM</span>
                    <span class="${baseClass}">${c.pd}PD</span>
                    <span class="${baseClass}">${c.eng}ENG</span>
                    <span class="${baseClass}">${c.da}DA</span>
                </div>
            `;
        };

        const formatLeverageTags = (list, vertical = false) => {
            const r = getLeverageRatios(list);
            const pmOff = r.engPm !== '∞' && r.engPm !== '0' && (parseFloat(r.engPm) < config.ratios.pm.min || parseFloat(r.engPm) > config.ratios.pm.max);
            const pdOff = r.engPd !== '∞' && r.engPd !== '0' && (parseFloat(r.engPd) < config.ratios.design.min || parseFloat(r.engPd) > config.ratios.design.max);
            const daOff = r.engDa !== '∞' && r.engDa !== '0' && (parseFloat(r.engDa) < config.ratios.data.min || parseFloat(r.engDa) > config.ratios.data.max);

            const std = "bg-slate-800 text-slate-100 border border-slate-700 px-2 py-0.5 rounded-md whitespace-nowrap";
            const err = "bg-red-600 text-white border border-red-500 px-2 py-0.5 rounded-md shadow-sm font-black whitespace-nowrap";

            return `
                <div class="flex ${vertical ? 'flex-col items-end gap-1' : 'items-center gap-1.5'} font-black text-[9px] uppercase tracking-tighter">
                    <span class="${pmOff ? err : std}">${r.engPm}:1 PM</span>
                    <span class="${pdOff ? err : std}">${r.engPd}:1 PD</span>
                    <span class="${daOff ? err : std}">${r.engDa}:1 DA</span>
                </div>
            `;
        };

        const getRoleColorClass = (role) => {
            const r = role.toLowerCase();
            if (r.includes('eng') && !r.includes('data')) return 'bg-indigo-50 text-indigo-600 border-indigo-100';
            if (r.includes('prod') && r.includes('manage')) return 'bg-amber-50 text-amber-600 border-amber-100';
            if (r.includes('prod') && r.includes('design')) return 'bg-rose-50 text-rose-600 border-rose-100';
            if (r.includes('data')) return 'bg-emerald-50 text-emerald-600 border-emerald-100';
            return 'bg-slate-50 text-slate-600 border-slate-100';
        };

        const updateModalSelects = () => {
            const rSel = document.getElementById('modal-role-select');
            const lSel = document.getElementById('modal-level-select');
            const tSel = document.getElementById('modal-tribe-select');
            const sSel = document.getElementById('modal-squad-select');
            const ltSel = document.getElementById('modal-ltitle-select');

            if (rSel) rSel.innerHTML = config.roles.map(r => `<option value="${r}">${r}</option>`).join('');
            if (lSel) lSel.innerHTML = `<option value="">(Optional) No Level</option>` + config.levels.map(l => `<option value="${l}">${l}</option>`).join('');
            if (tSel) tSel.innerHTML = tribes.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            if (ltSel) ltSel.innerHTML = `<option value="">Individual Contributor</option>` + config.leadershipTitles.map(t => `<option value="${t}">${t}</option>`).join('');

            // Populate secondary tribes multi-select (exclude primary tribe)
            const secondarySel = document.getElementById('modal-secondary-select');
            const updateSecondaryOptions = () => {
                const selectedTribe = tSel?.value;
                if (secondarySel) {
                    secondarySel.innerHTML = tribes
                        .filter(t => t.name !== selectedTribe)
                        .map(t => `<option value="${t.name}">${t.name}</option>`)
                        .join('');
                }
            };

            const updateSquadOptions = () => {
                const selectedTribe = tribes.find(t => t.name === tSel.value);
                if (selectedTribe && sSel) {
                    sSel.innerHTML = (selectedTribe.squads || []).map(s => `<option value="${s}">${s}</option>`).join('');
                } else if (sSel) {
                    sSel.innerHTML = `<option value="Unassigned">Unassigned</option>`;
                }
                // Update secondary tribes when primary tribe changes
                updateSecondaryOptions();
            };
            if (tSel) tSel.onchange = updateSquadOptions;
            updateSquadOptions();
            
            // Also populate edit modal tribe select
            const editTribeSel = document.getElementById('edit-person-tribe');
            if (editTribeSel) {
                editTribeSel.innerHTML = tribes.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            }
        };

        const getTribeLead = (tribeName, functionKey) => {
            const leads = personnel.filter(p => {
                const tribeMatch = p.tribe === tribeName || (p.secondaryTribes && p.secondaryTribes.includes(tribeName));
                const funcMatch = getFunctionKey(p.role) === functionKey;
                const activeLead = p.leadershipTitle && p.status === 'Hired';
                return tribeMatch && funcMatch && activeLead;
            });
            if (leads.length === 0) return "-";
            return leads.map(l => l.name).join(', ');
        };

        const getTribeFunctionCount = (tribeName, functionKey) => {
            return personnel.filter(p => p.tribe === tribeName && getFunctionKey(p.role) === functionKey && p.status === 'Hired').length;
        };

        // --- Render Summary Page ---
        const renderSummary = () => {
            const container = document.getElementById('summary-container');
            if (!container) return;

            // Category options are driven by config (synced)
            const categoryOptions = ['All', ...(config.categories || [])];

            // Filter context for the whole summary based on selected Category toggle
            let targetTribes = tribes;
            if (summaryCategory !== 'All') {
                targetTribes = tribes.filter(t => t.category === summaryCategory);
            }
            // Filter out excluded tribes
            targetTribes = targetTribes.filter(t => !config.excludedTribes.includes(t.name));
            
            const tribeNames = targetTribes.map(t => t.name);
            const filteredPersonnel = personnel.filter(p => tribeNames.includes(p.tribe));
            const hiredTotal = filteredPersonnel.filter(p => p.status === 'Hired').length;
            const vacancyTotal = filteredPersonnel.filter(p => p.status !== 'Hired').length;
            const ratios = getLeverageRatios(filteredPersonnel.filter(p => p.status === 'Hired'));
            const counts = getRoleCounts(filteredPersonnel.filter(p => p.status === 'Hired'));

            // ✅ FIXED: Effective goal should reflect planned seats in selected scope
            const effectiveGoal =
                summaryCategory === 'All'
                    ? (config.strategicGoal || personnel.length || 1)
                    : (filteredPersonnel.length || 1);

            // ✅ Heatmap data: Open roles by tribe/squad in this scope
            const openByTribeSquad = {};
            let maxOpen = 0;

            targetTribes.forEach(t => {
                openByTribeSquad[t.name] = {};
                (t.squads || []).forEach(sq => {
                    const openCount = filteredPersonnel.filter(p =>
                        p.tribe === t.name && p.squad === sq && p.status !== 'Hired'
                    ).length;
                    openByTribeSquad[t.name][sq] = openCount;
                    if (openCount > maxOpen) maxOpen = openCount;
                });
            });

            const heatBg = (n) => {
                if (!n) return 'background: rgba(148,163,184,0.08);'; // slate light
                const alpha = 0.08 + (0.45 * (n / (maxOpen || 1)));   // 0.08 -> 0.53
                return `background: rgba(239,68,68,${alpha.toFixed(3)});`; // red
            };

            container.innerHTML = `
                <!-- Category Toggle -->
                <div class="flex items-center gap-2 bg-slate-100/50 p-1.5 rounded-[28px] w-fit mb-12 border border-slate-200 shadow-inner">
                    ${categoryOptions.map(cat => `
                        <button onclick="window.setSummaryCategory('${cat}')" class="px-8 py-3 rounded-[22px] text-[11px] font-black uppercase tracking-widest transition-all ${summaryCategory === cat ? 'bg-white text-indigo-600 shadow-lg border border-slate-100' : 'text-slate-400 hover:text-slate-600'}">${cat}</button>
                    `).join('')}
                </div>

                <div class="grid lg:grid-cols-2 gap-10 mb-12">
                    <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50/50 -mr-16 -mt-16 rounded-full group-hover:scale-110 transition-transform duration-700"></div>
                        <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900 mb-8">${summaryCategory} Progress</h2>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between mb-4">
                                  <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Goal Realization</span>
                                  <span class="font-black">${hiredTotal} / ${effectiveGoal}</span>
                                </div>
                                <div class="h-4 bg-slate-50 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-600 rounded-full transition-all duration-1000" style="width: ${(hiredTotal / (effectiveGoal || 1)) * 100}%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-6 pt-4">
                                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Open Positions</p>
                                    <h3 class="text-3xl font-black text-red-500">${vacancyTotal}</h3>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Hired Rate</p>
                                    <h3 class="text-3xl font-black text-emerald-500">${Math.round((hiredTotal / (filteredPersonnel.length || 1)) * 100)}%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900 rounded-[48px] p-12 border border-slate-800 shadow-2xl text-white relative group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 -mr-16 -mt-16 rounded-full group-hover:scale-110 transition-transform duration-700"></div>
                        
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-black uppercase tracking-tighter">${summaryCategory} Ratios</h2>
                            
                            <!-- Multi-select dropdown for filtering ratios -->
                            <div class="relative">
                                <select onchange="window.toggleRatioRole(this.value); this.value='';" class="bg-slate-800 border border-slate-700 text-white rounded-xl px-4 py-2 text-[10px] font-black uppercase cursor-pointer">
                                    <option value="">Filter Ratios...</option>
                                    ${(() => {
                                        const hiredInScope = filteredPersonnel.filter(p => p.status === 'Hired');
                                        const availableRoles = config.roles.filter(role => {
                                            const count = hiredInScope.filter(p => p.role === role).length;
                                            return count > 0 && role.toLowerCase() !== 'eng';
                                        });
                                        return availableRoles.map(role => 
                                            '<option value="' + role + '">' + role + (selectedRatioRoles.includes(role) ? ' ✓' : '') + '</option>'
                                        ).join('');
                                    })()}
                                </select>
                                ${selectedRatioRoles.length > 0 ? `
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        ${selectedRatioRoles.map(r => '<span class="bg-slate-800 text-white px-2 py-1 rounded-lg text-[9px] font-bold flex items-center gap-1">' + r + '<i onclick="window.toggleRatioRole(\'' + r + '\')" class="fa-solid fa-times cursor-pointer opacity-60 hover:opacity-100"></i></span>').join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${(() => {
                            // Get all roles and their counts
                            const hiredInScope = filteredPersonnel.filter(p => p.status === 'Hired');
                            let roleData = config.roles.map(role => {
                                const count = hiredInScope.filter(p => p.role === role).length;
                                return { role, count };
                            }).filter(r => r.count > 0); // Only show roles with people
                            
                            // Custom sort order: Eng, PM, PD, DS, then everything else alphabetically
                            const sortOrder = ['Eng', 'PM', 'PD', 'DS'];
                            roleData.sort((a, b) => {
                                const aIndex = sortOrder.indexOf(a.role);
                                const bIndex = sortOrder.indexOf(b.role);
                                
                                // If both are in sortOrder, sort by their position
                                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                                // If only a is in sortOrder, a comes first
                                if (aIndex !== -1) return -1;
                                // If only b is in sortOrder, b comes first
                                if (bIndex !== -1) return 1;
                                // Neither in sortOrder, sort alphabetically
                                return a.role.localeCompare(b.role);
                            });
                            
                            const total = roleData.reduce((sum, r) => sum + r.count, 0);
                            
                            // Find Eng count for ratios
                            const engCount = roleData.find(r => r.role.toLowerCase().includes('eng') && !r.role.toLowerCase().includes('data'))?.count || 1;
                            
                            // Get Manager:IC ratio
                            const mgrRatio = getManagerRatio(hiredInScope);
                            
                            // Color palette for roles
                            const colors = ['indigo', 'rose', 'emerald', 'amber', 'purple', 'cyan', 'orange', 'pink'];
                            
                            // Filter roles based on selection (if any selected, only show those)
                            let displayRoles = roleData.filter(r => !r.role.toLowerCase().includes('eng') || r.role.toLowerCase().includes('data'));
                            if (selectedRatioRoles.length > 0) {
                                displayRoles = displayRoles.filter(r => selectedRatioRoles.includes(r.role));
                            }
                            
                            // Generate ratio cards for filtered roles
                            const ratioCards = displayRoles
                                .map((r, idx) => {
                                    const ratio = (engCount / (r.count || 1)).toFixed(1);
                                    const color = colors[idx % colors.length];
                                    const configKey = getFunctionKey(r.role);
                                    const targetRange = config.ratios[configKey] 
                                        ? 'Target ' + config.ratios[configKey].min + '-' + config.ratios[configKey].max
                                        : '';
                                    
                                    return `
                                        <div class="border-l-2 border-${color}-500 pl-6 py-2">
                                            <p class="text-[9px] font-black uppercase opacity-40 mb-2 tracking-widest">Eng : ${r.role}</p>
                                            <h3 class="text-3xl font-black">${ratio}:1</h3>
                                            ${targetRange ? '<p class="text-[8px] opacity-30 mt-1 uppercase tracking-widest">' + targetRange + '</p>' : ''}
                                        </div>
                                    `;
                                }).join('');
                            
                            // Add Manager:IC ratio card (always show)
                            const mgrCard = `
                                <div class="border-l-2 border-violet-500 pl-6 py-2">
                                    <p class="text-[9px] font-black uppercase opacity-40 mb-2 tracking-widest">IC : Manager</p>
                                    <h3 class="text-3xl font-black">${mgrRatio.ratio}:1</h3>
                                    <p class="text-[8px] opacity-30 mt-1 uppercase tracking-widest">${mgrRatio.ics} ICs, ${mgrRatio.managers} Mgrs</p>
                                </div>
                            `;
                            
                            // Generate absolute numbers line (in sorted order)
                            const absoluteLine = roleData.map(r => r.count + ' ' + r.role).join(' : ');
                            
                            // Generate percentages line
                            const percentagesLine = roleData.map(r => {
                                const pct = total > 0 ? Math.round((r.count / total) * 100) : 0;
                                return pct + '%';
                            }).join(' : ');
                            
                            return `
                                <div class="grid grid-cols-3 gap-6 mb-8">
                                    ${ratioCards}
                                    ${mgrCard}
                                </div>
                                
                                <!-- Absolute Numbers and Percentages -->
                                <div class="pt-6 border-t border-white/10 space-y-3">
                                    <div class="text-center">
                                        <p class="text-lg font-bold opacity-90">
                                            ${absoluteLine}
                                        </p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm font-medium opacity-60">
                                            (${percentagesLine})
                                        </p>
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                </div>

                <!-- Snapshot Table -->
                <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm animate-in overflow-hidden relative">
                    <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900 mb-10">Tribe Snapshot</h2>
                    <div class="overflow-x-auto no-scrollbar">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[11px] font-black text-slate-300 uppercase tracking-[0.2em] border-b border-slate-50">
                                    <th class="pb-6 pr-12 min-w-[220px]">Dimension</th>
                                    ${targetTribes.map(t => `<th class="pb-6 px-8 text-center min-w-[160px] font-black text-slate-900 uppercase tracking-tighter text-lg">${t.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr class="bg-slate-50/30"><td colspan="${targetTribes.length + 1}" class="py-3 px-4 text-[9px] font-black uppercase text-slate-400 tracking-widest">Leadership</td></tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-amber-500 tracking-widest">PM Lead</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-xs font-bold text-slate-600">${getTribeLead(t.name, 'prod')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-rose-500 tracking-widest">Design Lead</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-xs font-bold text-slate-600">${getTribeLead(t.name, 'design')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-indigo-500 tracking-widest">Eng Lead</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-xs font-bold text-slate-600">${getTribeLead(t.name, 'eng')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-emerald-500 tracking-widest">Data Lead</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-xs font-bold text-slate-600">${getTribeLead(t.name, 'data')}</td>`).join('')}</tr>
                                
                                <tr class="bg-slate-950 text-white"><td class="py-6 pl-6 font-black text-[11px] uppercase tracking-[0.2em]">Total Tribe (FTE)</td>${targetTribes.map(t => `<td class="py-6 px-8 text-center text-2xl font-black">${personnel.filter(p => p.tribe === t.name && p.status === 'Hired').length}</td>`).join('')}</tr>
                                
                                <tr class="bg-slate-50/30"><td colspan="${targetTribes.length + 1}" class="py-3 px-4 text-[9px] font-black uppercase text-slate-400 tracking-widest">Functional FTE Counts</td></tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-slate-900 tracking-widest">Eng</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-lg font-black text-indigo-600">${getTribeFunctionCount(t.name, 'eng')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-slate-900 tracking-widest">Product</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-lg font-black text-amber-600">${getTribeFunctionCount(t.name, 'prod')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-slate-900 tracking-widest">Design</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-lg font-black text-rose-600">${getTribeFunctionCount(t.name, 'design')}</td>`).join('')}</tr>
                                <tr><td class="py-4 pl-4 font-black text-[10px] uppercase text-slate-900 tracking-widest">Data</td>${targetTribes.map(t => `<td class="py-4 px-8 text-center text-lg font-black text-emerald-600">${getTribeFunctionCount(t.name, 'data')}</td>`).join('')}</tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Personnel Status Overview -->
                <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm mt-12 overflow-hidden">
                    <div class="mb-10">
                        <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900">Personnel Status Overview</h2>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-3">
                            ${summaryCategory} • Open, Hiring, Recent Hires & Departures
                        </p>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- OPEN POSITIONS -->
                        <div class="bg-slate-50 rounded-[32px] p-8 border border-slate-100">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-black uppercase text-slate-900">Open Positions</h3>
                                <span class="bg-slate-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black">
                                    ${filteredPersonnel.filter(p => p.status === 'Open').length}
                                </span>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                                ${filteredPersonnel.filter(p => p.status === 'Open').map(p => `
                                    <div class="bg-white rounded-2xl p-4 border border-slate-100 hover:shadow-md transition-all cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 text-lg uppercase tracking-tight">
                                                    ${p.tribe} / ${p.squad}
                                                </div>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase ${getRoleColorClass(p.role)}">${p.role}</span>
                                                    <span class="text-[9px] text-slate-400 font-medium">${p.level || 'N/A'}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-400 font-medium mt-2 truncate">
                                                    ${p.name || 'Open Role'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-slate-400 text-sm text-center py-8">No open positions</p>'}
                            </div>
                        </div>

                        <!-- HIRING IN PROGRESS -->
                        <div class="bg-amber-50 rounded-[32px] p-8 border border-amber-100">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-black uppercase text-slate-900">Hiring in Progress</h3>
                                <span class="bg-amber-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black">
                                    ${filteredPersonnel.filter(p => p.status === 'Hiring').length}
                                </span>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                                ${filteredPersonnel.filter(p => p.status === 'Hiring').map(p => `
                                    <div class="bg-white rounded-2xl p-4 border border-amber-200 hover:shadow-md transition-all cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 text-lg uppercase tracking-tight">
                                                    ${p.tribe} / ${p.squad}
                                                </div>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase ${getRoleColorClass(p.role)}">${p.role}</span>
                                                    <span class="text-[9px] text-slate-400 font-medium">${p.level || 'N/A'}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-400 font-medium mt-2 truncate">
                                                    ${p.name || 'Open Role'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-slate-400 text-sm text-center py-8">No active hiring</p>'}
                            </div>
                        </div>

                        <!-- RECENTLY HIRED (Last 7 days) -->
                        <div class="bg-emerald-50 rounded-[32px] p-8 border border-emerald-100">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-black uppercase text-slate-900">Recently Hired</h3>
                                <span class="bg-emerald-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black">
                                    ${(() => {
                                        const sevenDaysAgo = new Date();
                                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                                        return filteredPersonnel.filter(p => {
                                            if (p.status !== 'Hired') return false;
                                            if (!p.hiredDate) return false;
                                            const hiredDate = new Date(p.hiredDate);
                                            return hiredDate >= sevenDaysAgo;
                                        }).length;
                                    })()}
                                </span>
                            </div>
                            <div class="text-[9px] text-slate-500 font-medium mb-4">Last 7 days</div>
                            <div class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                                ${(() => {
                                    const sevenDaysAgo = new Date();
                                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                                    const recentHires = filteredPersonnel.filter(p => {
                                        if (p.status !== 'Hired') return false;
                                        if (!p.hiredDate) return false;
                                        const hiredDate = new Date(p.hiredDate);
                                        return hiredDate >= sevenDaysAgo;
                                    });
                                    
                                    if (recentHires.length === 0) {
                                        return '<p class="text-slate-400 text-sm text-center py-8">No recent hires</p>';
                                    }
                                    
                                    return recentHires.map(p => {
                                        const hiredDate = new Date(p.hiredDate);
                                        const daysAgo = Math.floor((new Date() - hiredDate) / (1000 * 60 * 60 * 24));
                                        return `
                                            <div class="bg-white rounded-2xl p-4 border border-emerald-200 hover:shadow-md transition-all cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="font-bold text-slate-900 text-sm truncate">${p.name}</div>
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <span class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase ${getRoleColorClass(p.role)}">${p.role}</span>
                                                            <span class="text-[9px] text-slate-400 font-medium">${p.level || 'N/A'}</span>
                                                        </div>
                                                        <div class="text-[9px] text-slate-500 font-medium mt-2">
                                                            ${p.tribe} / ${p.squad}
                                                        </div>
                                                    </div>
                                                    <div class="text-[9px] text-emerald-600 font-black uppercase whitespace-nowrap">
                                                        ${daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo + 'd ago'}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>

                        <!-- RECENTLY RESIGNED (Last 7 days) -->
                        <div class="bg-red-50 rounded-[32px] p-8 border border-red-100">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-black uppercase text-slate-900">Recently Resigned</h3>
                                <span class="bg-red-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black">
                                    ${(() => {
                                        const sevenDaysAgo = new Date();
                                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                                        return personnel.filter(p => {
                                            if (p.status !== 'Resigned') return false;
                                            if (!p.resignedDate) return false;
                                            const resignedDate = new Date(p.resignedDate);
                                            return resignedDate >= sevenDaysAgo;
                                        }).length;
                                    })()}
                                </span>
                            </div>
                            <div class="text-[9px] text-slate-500 font-medium mb-4">Last 7 days</div>
                            <div class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                                ${(() => {
                                    const sevenDaysAgo = new Date();
                                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                                    const recentResignations = personnel.filter(p => {
                                        if (p.status !== 'Resigned') return false;
                                        if (!p.resignedDate) return false;
                                        const resignedDate = new Date(p.resignedDate);
                                        return resignedDate >= sevenDaysAgo;
                                    });
                                    
                                    if (recentResignations.length === 0) {
                                        return '<p class="text-slate-400 text-sm text-center py-8">No recent resignations</p>';
                                    }
                                    
                                    return recentResignations.map(p => {
                                        const resignedDate = new Date(p.resignedDate);
                                        const daysAgo = Math.floor((new Date() - resignedDate) / (1000 * 60 * 60 * 24));
                                        return `
                                            <div class="bg-white rounded-2xl p-4 border border-red-200 hover:shadow-md transition-all cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="font-bold text-slate-900 text-sm truncate">${p.name}</div>
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <span class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase ${getRoleColorClass(p.role)}">${p.role}</span>
                                                            <span class="text-[9px] text-slate-400 font-medium">${p.level || 'N/A'}</span>
                                                        </div>
                                                        <div class="text-[9px] text-slate-500 font-medium mt-2">
                                                            ${p.tribe} / ${p.squad}
                                                        </div>
                                                    </div>
                                                    <div class="text-[9px] text-red-600 font-black uppercase whitespace-nowrap">
                                                        ${daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo + 'd ago'}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderTribeList = () => {
            const container = document.getElementById('tribes-container');
            if (!container) return;
            container.innerHTML = `
                <div class="flex justify-between items-center mb-8 pr-4">
                    <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900">Tribes & Squads</h2>
                    <div class="flex gap-3">
                        <button onclick="window.expandAllTribes()" class="bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-[9px] font-black uppercase text-slate-500 hover:bg-slate-50 transition-colors shadow-sm tracking-widest">Expand All Tribes</button>
                        <button onclick="window.collapseAllTribes()" class="bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-[9px] font-black uppercase text-slate-500 hover:bg-slate-50 transition-colors shadow-sm tracking-widest">Collapse All</button>
                    </div>
                </div>
            `;
            const ctxPersonnel = viewContext === 'hired' ? personnel.filter(p => p.status === 'Hired') : personnel;
            // Filter out excluded tribes
            const activeTribes = tribes.filter(t => !config.excludedTribes.includes(t.name));
            activeTribes.forEach((tribe, idx) => {
                const isExpanded = expandedTribes.includes(tribe.name);
                const tribePersonnel = ctxPersonnel.filter(p => p.tribe === tribe.name);
                const tribeAll = personnel.filter(p => p.tribe === tribe.name);
                const hiredCount = tribePersonnel.filter(p => p.status === 'Hired').length;
                const vacancyCount = tribeAll.filter(p => p.status !== 'Hired').length;
                const weight = ((tribePersonnel.length / (ctxPersonnel.length || 1)) * 100).toFixed(1);
                const div = document.createElement('div');
                div.className = "mb-12 animate-in";
                if (idx > 0) { const hr = document.createElement('hr'); hr.className = "border-slate-100 mb-10"; container.appendChild(hr); }
                div.innerHTML += `
                    <div class="flex flex-col mb-6">
                        <div class="flex items-center gap-5 cursor-pointer group" onclick="window.toggleTribe('${tribe.name}')">
                             <i class="fa-solid fa-chevron-down transition-transform ${isExpanded ? '' : '-rotate-90'} text-slate-300"></i>
                             <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900">${tribe.name}</h2>
                        </div>
                        <div class="flex items-center gap-3 mt-4 ml-8 overflow-x-auto no-scrollbar pb-2 text-[10px] font-black uppercase tracking-widest">
                            <span class="bg-[#ff5a00] text-white px-4 py-1.5 rounded-full whitespace-nowrap">${hiredCount} PEOPLE</span>
                            <span class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full whitespace-nowrap">${(tribe.squads || []).length} SQUADS</span>
                            <div class="bg-white border border-slate-100 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-sm">${formatCountsTag(tribePersonnel)}<span class="h-3 w-[1px] bg-slate-200 ml-1"></span><span class="text-slate-400 ml-1">Composition</span></div>
                            <div class="bg-slate-50 border border-slate-100 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-sm">${formatLeverageTags(tribePersonnel, false)}<span class="h-3 w-[1px] bg-slate-200 ml-1"></span><button onclick="window.setViewContext('${viewContext === 'all' ? 'hired' : 'all'}')" class="text-indigo-500 hover:text-orange-700 cursor-pointer ml-1">${viewContext}</button></div>
                            <span class="bg-slate-50 border border-slate-100 px-4 py-1.5 rounded-full text-indigo-600 whitespace-nowrap">${weight}% WEIGHT</span>
                            <span class="bg-red-50 px-4 py-1.5 rounded-full text-red-400">${vacancyCount} OPEN ROLES</span>
                            <button onclick="window.manageTribe('${tribe.name}')" class="bg-slate-950 text-white px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-orange-600 transition-colors shadow-lg ml-2">Manage Tribe</button>
                        </div>
                    </div>
                    <div class="${isExpanded ? 'grid' : 'hidden'} lg:grid-cols-2 xl:grid-cols-3 gap-8">
                        ${(tribe.squads || []).map(sq => {
                            const squadMbs = ctxPersonnel.filter(p => p.tribe === tribe.name && p.squad === sq);
                            const totalHC = personnel.filter(p => p.tribe === tribe.name && p.squad === sq).length;
                            const vcs = personnel.filter(p => p.tribe === tribe.name && p.squad === sq && p.status !== 'Hired').length;
                            const isSqExpanded = expandedSquads.includes(sq);
                            return `
                                <div ondragover="window.handleDragOver(event)" ondragleave="window.handleDragLeave(event)" ondrop="window.handleDrop(event, '${sq}', '${tribe.name}')" class="bg-white rounded-[48px] p-10 border border-slate-100 shadow-sm relative group hover:shadow-2xl transition-all duration-500">
                                    <div class="flex justify-between items-start mb-10">
                                        <div class="pr-4 min-w-0 flex-1"><h3 class="font-black text-2xl uppercase tracking-tighter text-slate-900 break-words leading-none">${sq}</h3><div class="mt-3">${formatCountsTag(squadMbs)}</div></div>
                                        <div class="flex flex-col items-end flex-shrink-0">
                                            <div class="bg-slate-50 text-slate-900 border border-slate-100 px-4 py-2.5 rounded-2xl flex items-center justify-center font-black text-sm shadow-sm min-w-[50px]">${totalHC} ${vcs > 0 ? `<span class="mx-2 text-slate-200">|</span> <span class="text-red-600">${vcs}</span>` : ''}</div>
                                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">Headcount</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="flex -space-x-4">${squadMbs.slice(0, 4).map(m => `<div class="w-11 h-11 rounded-full border-[4px] border-white bg-slate-100 flex items-center justify-center text-xs font-black text-slate-600 shadow-sm">${m.name.charAt(0)}</div>`).join('')}</div>
                                            <button onclick="window.toggleSquadExpand('${sq}')" class="w-10 h-10 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-orange-50 hover:text-[#ff5a00] transition-all active:scale-90 shadow-sm"><i class="fa-solid fa-chevron-${isSqExpanded ? 'up' : 'down'} text-[10px]"></i></button>
                                        </div>
                                        <button onclick="window.manageSquad('${sq}', '${tribe.name}')" class="bg-[#ff5a00] text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-lg shadow-orange-100">Manage Squad</button>
                                    </div>
                                    ${isSqExpanded ? `<div class="mt-8 space-y-3 border-t border-slate-50 pt-8 animate-in">${squadMbs.map(m => `<div draggable="true" ondragstart="window.handleDragStart(event, '${m.id}')" ondragend="window.handleDragEnd(event)" class="flex justify-between items-center p-3 rounded-2xl border ${getRoleColorClass(m.role)}"><div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full ${m.status === 'Hired' ? 'bg-current opacity-60' : 'bg-white border border-current opacity-40'}"></div><div class="flex flex-col"><span class="text-xs font-black uppercase tracking-tight">${m.name}</span>${m.leadershipTitle ? `<span class="text-[8px] font-black text-indigo-500 uppercase tracking-widest">${m.leadershipTitle}</span>` : ''}</div></div><div class="text-[9px] font-black uppercase opacity-60">${getRoleAbbr(m.role)}</div></div>`).join('')}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        };

        const renderFunctionsList = () => {
            const container = document.getElementById('functions-container');
            if (!container) return;
            
            // Filter out excluded tribes from personnel
            const activePersonnel = filterActivePersonnel(personnel);
            
            // Get all unique roles from active personnel
            const allRoles = [...new Set(activePersonnel.map(p => p.role))].filter(r => r);
            
            // Create function data for each role
            const functionData = allRoles.map(role => {
                const rolePersonnel = activePersonnel.filter(p => p.role === role);
                const hiredCount = rolePersonnel.filter(p => p.status === 'Hired').length;
                const vacancyCount = rolePersonnel.filter(p => p.status !== 'Hired').length;
                const totalActive = rolePersonnel.length;
                const currentMix = ((hiredCount / (activePersonnel.filter(p => p.status === 'Hired').length || 1)) * 100).toFixed(1);
                
                // Get function key and color
                const funcKey = getFunctionKey(role);
                const colors = { eng: 'indigo', prod: 'amber', design: 'rose', data: 'emerald' };
                const theme = colors[funcKey] || 'slate';
                
                const seniorCount = rolePersonnel.filter(p => parseInt(p.level?.replace(/\D/g, '') || '0') >= 4).length;
                const leadCount = rolePersonnel.filter(p => p.leadershipTitle || p.level?.startsWith('M') || p.level?.startsWith('L')).length;
                
                return {
                    role,
                    funcKey,
                    theme,
                    rolePersonnel,
                    hiredCount,
                    vacancyCount,
                    totalActive,
                    currentMix,
                    seniorCount,
                    leadCount
                };
            });
            
            // Sort by hired count (descending)
            functionData.sort((a, b) => b.hiredCount - a.hiredCount);
            
            // Render header
            container.innerHTML = `
                <div class="flex justify-between items-center mb-12">
                    <div>
                        <h2 class="text-4xl font-black uppercase tracking-tighter text-slate-900">Job Families</h2>
                        <p class="text-sm text-slate-500 font-medium mt-2">Sorted by filled headcount • ${functionData.length} families active</p>
                    </div>
                </div>
            `;
            
            // Render each function
            functionData.forEach(data => {
                const isDeepExpanded = expandedFunctions.includes(data.role);
                const card = document.createElement('div');
                card.className = "bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm mb-8 animate-in relative overflow-hidden transition-all duration-500";
                card.innerHTML = `
                    <div class="grid lg:grid-cols-4 gap-12 items-center">
                        <div class="col-span-1 border-r border-slate-50 pr-8">
                            <h3 class="text-2xl font-black uppercase tracking-tighter text-slate-900 mb-2">${data.role}</h3>
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-${data.theme}-50 text-${data.theme}-600 text-[10px] font-black uppercase tracking-widest">
                                ${data.funcKey.toUpperCase()}
                            </div>
                        </div>
                        <div class="col-span-1 text-center border-r border-slate-50 pr-8">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Headcount</p>
                            <div class="flex items-center justify-center gap-4">
                                <div>
                                    <h4 class="text-3xl font-black text-emerald-600">${data.hiredCount}</h4>
                                    <span class="text-[8px] font-black text-slate-300 uppercase">Filled</span>
                                </div>
                                <div class="text-slate-200 text-xl font-thin">/</div>
                                <div>
                                    <h4 class="text-3xl font-black text-slate-400">${data.totalActive}</h4>
                                    <span class="text-[8px] font-black text-slate-300 uppercase">Total</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 text-center border-r border-slate-50 pr-8">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Mix & Vacancies</p>
                            <h4 class="text-3xl font-black text-slate-900">${data.currentMix}%</h4>
                            <span class="text-[8px] font-black text-slate-300 uppercase">Current Mix</span>
                            <div class="mt-3">
                                <span class="bg-amber-50 text-amber-600 px-3 py-1 rounded-full text-[8px] font-black uppercase">${data.vacancyCount} Open</span>
                            </div>
                        </div>
                        <div class="col-span-1 text-right flex flex-col items-end gap-3">
                            <button onclick="window.toggleFunctionDeepDive('${data.role}')" class="bg-[#ff5a00] text-white px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-600 transition-colors shadow-lg">
                                ${isDeepExpanded ? 'Collapse' : 'Expand'} Roster
                            </button>
                        </div>
                    </div>
                    
                    ${isDeepExpanded ? `
                        <div class="mt-12 pt-12 border-t border-slate-50 animate-in">
                            <div class="grid lg:grid-cols-3 gap-8 mb-12">
                                <div class="bg-slate-50 p-6 rounded-3xl">
                                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Seniority Distribution</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-[9px] font-black uppercase">Senior (IC4+)</span>
                                            <span class="font-bold">${data.seniorCount}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-[9px] font-black uppercase">Leadership Titles</span>
                                            <span class="font-bold text-indigo-600">${data.leadCount}</span>
                                        </div>
                                        <div class="flex justify-between items-center border-t pt-2 border-slate-200">
                                            <span class="text-[9px] font-black uppercase">Senior Density</span>
                                            <span class="text-indigo-600 font-black">${((data.seniorCount / (data.hiredCount || 1)) * 100).toFixed(0)}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-3xl col-span-2">
                                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Tribe Distribution</h5>
                                    <div class="flex flex-wrap gap-3">
                                        ${[...new Set(data.rolePersonnel.map(p => p.tribe))]
                                            .filter(t => t)
                                            .slice(0, 8)
                                            .map(t => {
                                                const count = data.rolePersonnel.filter(p => p.tribe === t).length;
                                                return `
                                                    <div class="bg-white border border-slate-200 px-4 py-2 rounded-2xl flex items-center gap-3 shadow-sm">
                                                        <span class="text-[9px] font-black uppercase text-slate-900">${t}</span>
                                                        <span class="bg-${data.theme}-50 text-${data.theme}-600 px-2 py-0.5 rounded-lg text-[10px] font-black">${count}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="text-xl font-black uppercase tracking-tighter text-slate-900 mb-6">${data.role} Roster</h5>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-[10px] font-black text-slate-300 uppercase tracking-widest border-b">
                                            <th class="pb-4">Name</th>
                                            <th class="pb-4">Level</th>
                                            <th class="pb-4">Tribe / Squad</th>
                                            <th class="pb-4 text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.rolePersonnel
                                            .filter(m => m.status !== 'Resigned')
                                            .map(m => `
                                                <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50 cursor-pointer transition-colors" onclick="window.openRosterEditModal('${m.id}')">
                                                    <td class="py-4">
                                                        <span class="font-bold text-slate-800 text-sm block">${m.name}</span>
                                                        ${m.leadershipTitle ? `<span class="text-[8px] font-black text-indigo-500 uppercase tracking-widest">${m.leadershipTitle}</span>` : ''}
                                                    </td>
                                                    <td class="py-4 font-mono text-xs text-slate-400">${m.level || 'N/A'}</td>
                                                    <td class="py-4">
                                                        <span class="text-[10px] font-black uppercase text-slate-700 block">${m.tribe || 'N/A'}</span>
                                                        <span class="text-[9px] font-medium text-slate-400 uppercase">${m.squad || 'N/A'}</span>
                                                        ${m.secondaryTribes && m.secondaryTribes.length ? `<div class="text-[8px] text-slate-300 uppercase italic mt-1">+ ${m.secondaryTribes.join(', ')}</div>` : ''}
                                                    </td>
                                                    <td class="py-4 text-right">
                                                        <span class="text-[10px] font-black uppercase ${m.status === 'Hired' ? 'text-emerald-500' : m.status === 'Hiring' ? 'text-amber-500' : 'text-slate-400'}">${m.status}</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : `
                        <div class="mt-10 h-2 bg-slate-50 rounded-full overflow-hidden">
                            <div class="h-full bg-${data.theme}-500 rounded-full transition-all duration-1000" style="width: ${Math.min((data.hiredCount / (data.totalActive || 1)) * 100, 100)}%"></div>
                        </div>
                    `}
                `;
                container.appendChild(card);
            });
        };

        const renderTribeManage = () => {
            const container = document.getElementById('tribe-manage-view-content');
            if (!container || !managedTribeContext.name) return;
            
            let tribeMbs = personnel.filter(p => 
                p.tribe === managedTribeContext.name || 
                (p.secondaryTribes && p.secondaryTribes.includes(managedTribeContext.name))
            ).filter(p => p.status !== 'Resigned');
            
            // Apply search filter
            if (tribeManageFilters.search) {
                const searchTerm = tribeManageFilters.search.toLowerCase();
                tribeMbs = tribeMbs.filter(p => 
                    (p.name || '').toLowerCase().includes(searchTerm) ||
                    (p.role || '').toLowerCase().includes(searchTerm) ||
                    (p.squad || '').toLowerCase().includes(searchTerm) ||
                    (p.level || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply sorting
            tribeMbs.sort((a, b) => {
                let aVal, bVal;
                switch(tribeManageFilters.sortBy) {
                    case 'name':
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                        break;
                    case 'role':
                        aVal = (a.role || '').toLowerCase();
                        bVal = (b.role || '').toLowerCase();
                        break;
                    case 'squad':
                        aVal = (a.squad || '').toLowerCase();
                        bVal = (b.squad || '').toLowerCase();
                        break;
                    case 'level':
                        aVal = (a.level || '').toLowerCase();
                        bVal = (b.level || '').toLowerCase();
                        break;
                    case 'status':
                        aVal = (a.status || '').toLowerCase();
                        bVal = (b.status || '').toLowerCase();
                        break;
                    default:
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                }
                
                if (tribeManageFilters.sortOrder === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            const counts = getRoleCounts(tribeMbs);
            const ratios = getLeverageRatios(tribeMbs);
            const hiredCount = tribeMbs.filter(p => p.status === 'Hired').length;
            const openCount = tribeMbs.filter(p => p.status === 'Open' || p.status === 'Hiring').length;
            
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-10">
                    <button onclick="window.setTab('tribes')" class="w-12 h-12 rounded-2xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-[#ff5a00] hover:shadow-lg transition-all">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="text-4xl font-black uppercase tracking-tighter">${managedTribeContext.name} Orchestration</h2>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">Full Tribe Management</p>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white p-10 rounded-[48px] border border-slate-100 shadow-sm">
                        <h4 class="text-[11px] font-black uppercase text-indigo-500 mb-6 tracking-widest">Aggregate Leverage</h4>
                        <div class="space-y-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-[9px] text-slate-400 uppercase font-black mb-1">Eng : PM</p>
                                    <h3 class="text-3xl font-black">${ratios.engPm}:1</h3>
                                    <p class="text-[10px] text-slate-500 font-medium mt-2">${counts.eng} Eng : ${counts.pm} PM</p>
                                    <p class="text-[9px] text-slate-400 font-medium mt-1">${counts.eng} Eng, ${counts.pm} PM</p>
                                </div>
                                <div class="text-right text-[8px] font-black text-slate-300 uppercase">Target ${config.ratios.pm.min}-${config.ratios.pm.max}</div>
                            </div>
                            <div class="flex justify-between items-start pt-4 border-t border-slate-50">
                                <div>
                                    <p class="text-[9px] text-slate-400 uppercase font-black mb-1">Eng : Design</p>
                                    <h3 class="text-3xl font-black">${ratios.engPd}:1</h3>
                                    <p class="text-[10px] text-slate-500 font-medium mt-2">${counts.eng} Eng : ${counts.pd} Design</p>
                                    <p class="text-[9px] text-slate-400 font-medium mt-1">${counts.eng} Eng, ${counts.pd} Design</p>
                                </div>
                                <div class="text-right text-[8px] font-black text-slate-300 uppercase">Target ${config.ratios.design.min}-${config.ratios.design.max}</div>
                            </div>
                            ${(() => {
                                const mgrRatio = getManagerRatio(tribeMbs);
                                return `
                                    <div class="flex justify-between items-start pt-4 border-t border-slate-50">
                                        <div>
                                            <p class="text-[9px] text-slate-400 uppercase font-black mb-1">IC : Manager</p>
                                            <h3 class="text-3xl font-black">${mgrRatio.ratio}:1</h3>
                                            <p class="text-[10px] text-slate-500 font-medium mt-2">${mgrRatio.ics} ICs : ${mgrRatio.managers} Mgrs</p>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-[48px] border border-slate-100 shadow-sm">
                        <h4 class="text-[11px] font-black uppercase text-emerald-500 mb-6 tracking-widest">Tribe Composition</h4>
                        <div class="space-y-3">
                            ${(() => {
                                const total = counts.eng + counts.pm + counts.pd + counts.da;
                                const pctEng = total > 0 ? Math.round((counts.eng / total) * 100) : 0;
                                const pctPm = total > 0 ? Math.round((counts.pm / total) * 100) : 0;
                                const pctPd = total > 0 ? Math.round((counts.pd / total) * 100) : 0;
                                const pctDa = total > 0 ? Math.round((counts.da / total) * 100) : 0;
                                
                                return `
                                    <div class="text-lg font-black text-slate-900">
                                        ${counts.eng} Eng : ${counts.pm} PM : ${counts.pd} Design : ${counts.da} Data
                                    </div>
                                    <div class="text-sm font-bold text-slate-500">
                                        (${pctEng}% : ${pctPm}% : ${pctPd}% : ${pctDa}%)
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-100">
                                        <div class="bg-indigo-50 p-3 rounded-2xl"><p class="text-[9px] text-indigo-600 uppercase font-black mb-1">Eng</p><h3 class="text-xl font-black text-indigo-900">${counts.eng}</h3></div>
                                        <div class="bg-amber-50 p-3 rounded-2xl"><p class="text-[9px] text-amber-600 uppercase font-black mb-1">Product</p><h3 class="text-xl font-black text-amber-900">${counts.pm}</h3></div>
                                        <div class="bg-rose-50 p-3 rounded-2xl"><p class="text-[9px] text-rose-600 uppercase font-black mb-1">Design</p><h3 class="text-xl font-black text-rose-900">${counts.pd}</h3></div>
                                        <div class="bg-emerald-50 p-3 rounded-2xl"><p class="text-[9px] text-emerald-600 uppercase font-black mb-1">Data</p><h3 class="text-xl font-black text-emerald-900">${counts.da}</h3></div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    <div class="bg-slate-900 p-10 rounded-[48px] shadow-2xl text-white">
                        <h4 class="text-[11px] font-black uppercase opacity-40 mb-6 tracking-widest">Tribe Summary</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-white/10 pb-4">
                                <span class="text-[10px] uppercase opacity-60">Primary FTE</span>
                                <span class="font-black">${personnel.filter(p => p.tribe === managedTribeContext.name && p.status !== 'Resigned').length}</span>
                            </div>
                            <div class="flex justify-between border-b border-white/10 pb-4">
                                <span class="text-[10px] uppercase opacity-60">Total Active</span>
                                <span class="font-black">${tribeMbs.length}</span>
                            </div>
                            <div class="flex justify-between pb-2">
                                <span class="text-[10px] uppercase opacity-60">Filled Ratio</span>
                                <span class="font-black text-emerald-400">${Math.round((hiredCount / (tribeMbs.length || 1)) * 100)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm">
                    <h4 class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Tribe Master Roster</h4>
                    
                    <!-- Search and Sort Controls -->
                    <div class="mb-6 flex items-center gap-4">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-sm"></i>
                            <input type="text" placeholder="Search tribe members..." oninput="window.updateTribeManageFilter('search', this.value)" class="w-full bg-slate-50 border-none rounded-2xl pl-12 pr-4 py-3 font-medium text-sm">
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 rounded-2xl px-4 py-3">
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Sort:</span>
                            <select onchange="window.updateTribeManageFilter('sortBy', this.value)" class="bg-transparent border-none text-[10px] font-black uppercase cursor-pointer p-0">
                                <option value="name">Name</option>
                                <option value="role">Role</option>
                                <option value="squad">Squad</option>
                                <option value="level">Level</option>
                                <option value="status">Status</option>
                            </select>
                            <button onclick="window.toggleTribeManageSort()" class="text-slate-400 hover:text-slate-900">
                                <i class="fa-solid fa-arrow-down-a-z text-sm" id="tribe-sort-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-sm text-slate-500 font-medium mb-4">
                        <i class="fa-solid fa-info-circle text-[#ff5a00] mr-2"></i>
                        Click any row to edit details
                    </p>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[11px] font-black text-slate-300 uppercase tracking-widest border-b border-slate-50">
                                    <th class="pb-6">Name</th>
                                    <th class="pb-6">Role</th>
                                    <th class="pb-6">Assignment</th>
                                    <th class="pb-6">Seniority</th>
                                    <th class="pb-6 text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tribeMbs.map(m => `
                                    <tr class="group border-b border-slate-50/50 hover:bg-slate-50 cursor-pointer transition-colors" onclick="window.openRosterEditModal('${m.id}')">
                                        <td class="py-5">
                                            <span class="font-bold text-slate-800 block">${m.name}</span>
                                            ${m.leadershipTitle ? `<span class="text-[8px] font-black text-indigo-500 uppercase tracking-widest">${m.leadershipTitle}</span>` : ''}
                                        </td>
                                        <td class="py-5">
                                            <span class="px-3 py-1 rounded-xl text-[10px] font-black uppercase ${getRoleColorClass(m.role)}">${m.role}</span>
                                        </td>
                                        <td class="py-5">
                                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">${m.tribe === managedTribeContext.name ? m.squad : 'Coverage'}</span>
                                        </td>
                                        <td class="py-5 font-mono text-xs text-slate-400">${m.level || 'N/A'}</td>
                                        <td class="py-5 text-right">
                                            <span class="text-[10px] font-black uppercase ${m.status === 'Hired' ? 'text-emerald-500' : m.status === 'Resigned' ? 'text-slate-400' : 'text-amber-500'}">${m.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex items-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                <span class="font-bold text-slate-700">${hiredCount} Hired</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                <span class="font-bold text-slate-700">${openCount} Open</span>
                            </div>
                            <div class="h-4 w-px bg-slate-200"></div>
                            <span class="text-slate-500 font-medium">${tribeMbs.length} Total</span>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderSquadManage = () => {
            const container = document.getElementById('squad-manage-view-content');
            if (!container || !managedSquadContext.squad) return;
            
            let squadMbs = personnel.filter(p => p.tribe === managedSquadContext.tribe && p.squad === managedSquadContext.squad && p.status !== 'Resigned');
            
            // Apply search filter
            if (squadManageFilters.search) {
                const searchTerm = squadManageFilters.search.toLowerCase();
                squadMbs = squadMbs.filter(p => 
                    (p.name || '').toLowerCase().includes(searchTerm) ||
                    (p.role || '').toLowerCase().includes(searchTerm) ||
                    (p.level || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply sorting
            squadMbs.sort((a, b) => {
                let aVal, bVal;
                switch(squadManageFilters.sortBy) {
                    case 'name':
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                        break;
                    case 'role':
                        aVal = (a.role || '').toLowerCase();
                        bVal = (b.role || '').toLowerCase();
                        break;
                    case 'level':
                        aVal = (a.level || '').toLowerCase();
                        bVal = (b.level || '').toLowerCase();
                        break;
                    case 'status':
                        aVal = (a.status || '').toLowerCase();
                        bVal = (b.status || '').toLowerCase();
                        break;
                    default:
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                }
                
                if (squadManageFilters.sortOrder === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            const hiredCount = squadMbs.filter(p => p.status === 'Hired').length;
            const openCount = squadMbs.filter(p => p.status === 'Open' || p.status === 'Hiring').length;
            const counts = getRoleCounts(squadMbs);
            const ratios = getLeverageRatios(squadMbs);
            
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-10">
                    <button onclick="window.setTab('tribes')" class="w-12 h-12 rounded-2xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-[#ff5a00] hover:shadow-lg transition-all">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="text-4xl font-black uppercase tracking-tighter">${managedSquadContext.squad} Dashboard</h2>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">${managedSquadContext.tribe} Tribe</p>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white p-10 rounded-[48px] border border-slate-100 shadow-sm">
                        <h4 class="text-[11px] font-black uppercase text-indigo-500 mb-6 tracking-widest">Leverage Ratios</h4>
                        <div class="space-y-6">
                            <div class="flex justify-between items-end">
                                <div><p class="text-[9px] text-slate-400 uppercase font-black mb-1">Eng : PM</p><h3 class="text-3xl font-black">${ratios.engPm}:1</h3></div>
                                <div class="text-right text-[8px] font-black text-slate-300 uppercase">Target ${config.ratios.pm.min}-${config.ratios.pm.max}</div>
                            </div>
                            <div class="flex justify-between items-end pt-4 border-t border-slate-50">
                                <div><p class="text-[9px] text-slate-400 uppercase font-black mb-1">Eng : Design</p><h3 class="text-3xl font-black">${ratios.engPd}:1</h3></div>
                                <div class="text-right text-[8px] font-black text-slate-300 uppercase">Target ${config.ratios.design.min}-${config.ratios.design.max}</div>
                            </div>
                            ${(() => {
                                const mgrRatio = getManagerRatio(squadMbs);
                                return `
                                    <div class="flex justify-between items-end pt-4 border-t border-slate-50">
                                        <div><p class="text-[9px] text-slate-400 uppercase font-black mb-1">IC : Manager</p><h3 class="text-3xl font-black">${mgrRatio.ratio}:1</h3></div>
                                        <div class="text-right text-[8px] font-black text-slate-300 uppercase">${mgrRatio.ics} ICs, ${mgrRatio.managers} Mgrs</div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-[48px] border border-slate-100 shadow-sm">
                        <h4 class="text-[11px] font-black uppercase text-emerald-500 mb-6 tracking-widest">Composition</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-3xl"><p class="text-[9px] text-slate-400 uppercase font-black mb-1">Eng</p><h3 class="text-2xl font-black">${counts.eng}</h3></div>
                            <div class="bg-slate-50 p-4 rounded-3xl"><p class="text-[9px] text-slate-400 uppercase font-black mb-1">PM</p><h3 class="text-2xl font-black">${counts.pm}</h3></div>
                            <div class="bg-slate-50 p-4 rounded-3xl"><p class="text-[9px] text-slate-400 uppercase font-black mb-1">Design</p><h3 class="text-2xl font-black">${counts.pd}</h3></div>
                            <div class="bg-slate-50 p-4 rounded-3xl"><p class="text-[9px] text-slate-400 uppercase font-black mb-1">Data</p><h3 class="text-2xl font-black">${counts.da}</h3></div>
                        </div>
                    </div>
                    <div class="bg-[#ff5a00] p-10 rounded-[48px] shadow-2xl shadow-orange-100 text-white">
                        <h4 class="text-[11px] font-black uppercase opacity-60 mb-6 tracking-widest">Orchestration</h4>
                        <p class="text-lg font-medium leading-tight mb-8">Manage squad assignments and operational health directly from this dashboard.</p>
                        <button onclick="window.openEntryModal('${managedSquadContext.tribe}', '${managedSquadContext.squad}')" class="w-full bg-white text-[#ff5a00] py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Add New Seat</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm">
                    <h4 class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Squad Roster</h4>
                    
                    <!-- Search and Sort Controls -->
                    <div class="mb-6 flex items-center gap-4">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-sm"></i>
                            <input type="text" placeholder="Search squad members..." oninput="window.updateSquadManageFilter('search', this.value)" class="w-full bg-slate-50 border-none rounded-2xl pl-12 pr-4 py-3 font-medium text-sm">
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 rounded-2xl px-4 py-3">
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Sort:</span>
                            <select onchange="window.updateSquadManageFilter('sortBy', this.value)" class="bg-transparent border-none text-[10px] font-black uppercase cursor-pointer p-0">
                                <option value="name">Name</option>
                                <option value="role">Role</option>
                                <option value="level">Level</option>
                                <option value="status">Status</option>
                            </select>
                            <button onclick="window.toggleSquadManageSort()" class="text-slate-400 hover:text-slate-900">
                                <i class="fa-solid fa-arrow-down-a-z text-sm" id="squad-sort-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-sm text-slate-500 font-medium mb-4">
                        <i class="fa-solid fa-info-circle text-[#ff5a00] mr-2"></i>
                        Click any row to edit details
                    </p>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[11px] font-black text-slate-300 uppercase tracking-widest border-b border-slate-50">
                                    <th class="pb-6">Name</th>
                                    <th class="pb-6">Role</th>
                                    <th class="pb-6">Seniority</th>
                                    <th class="pb-6 text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${squadMbs.map(m => `
                                    <tr class="group border-b border-slate-50/50 hover:bg-slate-50 cursor-pointer transition-colors" onclick="window.openRosterEditModal('${m.id}')">
                                        <td class="py-5 font-bold text-slate-800">${m.name}${m.leadershipTitle ? `<div class="text-[8px] font-black uppercase text-indigo-500 mt-1">${m.leadershipTitle}</div>` : ''}</td>
                                        <td class="py-5"><span class="px-3 py-1 rounded-xl text-[10px] font-black uppercase ${getRoleColorClass(m.role)}">${m.role}</span></td>
                                        <td class="py-5 font-mono text-xs text-slate-400">${m.level || 'N/A'}</td>
                                        <td class="py-5 text-right">
                                            <span class="text-[10px] font-black uppercase ${m.status === 'Hired' ? 'text-emerald-500' : m.status === 'Resigned' ? 'text-slate-400' : 'text-amber-500'}">${m.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex items-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                <span class="font-bold text-slate-700">${hiredCount} Hired</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                <span class="font-bold text-slate-700">${openCount} Open</span>
                            </div>
                            <div class="h-4 w-px bg-slate-200"></div>
                            <span class="text-slate-500 font-medium">${squadMbs.length} Total</span>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRoster = () => {
            const container = document.getElementById('roster-view-content');
            if (!container) return;
            
            // Use helper function for filtering and sorting
            const filtered = getFilteredRosterPersonnel();
            
            // Calculate stats for filtered results
            const hiredCount = filtered.filter(p => p.status === 'Hired').length;
            const openCount = filtered.filter(p => p.status === 'Open' || p.status === 'Hiring').length;
            const resignedCount = filtered.filter(p => p.status === 'Resigned').length;
            
            // Get squad options for bulk update
            const allSquads = [...new Set(tribes.flatMap(t => t.squads || []))];
            
            // Render the entire view
            container.innerHTML = `
                <div class="bg-white rounded-[56px] p-16 border border-slate-100 shadow-sm">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8 mb-12">
                        <h2 class="text-4xl font-black uppercase text-slate-900 tracking-tighter">Master Roster</h2>
                        <button onclick="window.openEntryModal()" class="bg-[#ff5a00] text-white px-8 py-4 rounded-3xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-orange-100 hover:scale-105 active:scale-95 transition-all">Add Headcount</button>
                    </div>
                    
                    <!-- Bulk Actions Bar -->
                    ${selectedRosterIds.size > 0 ? `
                        <div class="mb-6 p-6 rounded-3xl bg-indigo-50 border-2 border-indigo-200">
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-black">
                                        ${selectedRosterIds.size}
                                    </div>
                                    <span class="font-black text-slate-900">Selected</span>
                                </div>
                                
                                <div class="h-8 w-px bg-indigo-200"></div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-black text-slate-500 uppercase">Update Role:</span>
                                    <select onchange="if(this.value) window.applyBulkUpdate('role', this.value); this.value='';" class="bg-white border-indigo-200 rounded-xl px-4 py-2 text-xs font-bold">
                                        <option value="">Select...</option>
                                        ${config.roles.map(r => `<option value="${r}">${r}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-black text-slate-500 uppercase">Update Tribe:</span>
                                    <select onchange="if(this.value) window.applyBulkUpdate('tribe', this.value); this.value='';" class="bg-white border-indigo-200 rounded-xl px-4 py-2 text-xs font-bold">
                                        <option value="">Select...</option>
                                        ${tribes.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-black text-slate-500 uppercase">Update Squad:</span>
                                    <select onchange="if(this.value) window.applyBulkUpdate('squad', this.value); this.value='';" class="bg-white border-indigo-200 rounded-xl px-4 py-2 text-xs font-bold">
                                        <option value="">Select...</option>
                                        ${allSquads.map(s => `<option value="${s}">${s}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-black text-slate-500 uppercase">Update Status:</span>
                                    <select onchange="if(this.value) window.applyBulkUpdate('status', this.value); this.value='';" class="bg-white border-indigo-200 rounded-xl px-4 py-2 text-xs font-bold">
                                        <option value="">Select...</option>
                                        <option value="Hired">Hired</option>
                                        <option value="Hiring">Hiring</option>
                                        <option value="Open">Open</option>
                                        <option value="Resigned">Resigned</option>
                                    </select>
                                </div>
                                
                                <button onclick="window.clearRosterSelection()" class="ml-auto bg-white border-2 border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-slate-50 transition-colors">
                                    Clear Selection
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Search and Filters -->
                    <div class="mb-8 space-y-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="relative flex-1 min-w-[300px]">
                                <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 text-sm"></i>
                                <input type="text" placeholder="Search name, role, tribe, squad..." value="${rosterFilters.search}" oninput="window.updateRosterFilter('search', this.value)" class="w-full bg-slate-50 border-none rounded-2xl pl-14 pr-6 py-4 font-bold text-sm focus:ring-2 focus:ring-indigo-100 transition-all">
                            </div>
                            <select onchange="window.updateRosterFilter('role', this.value)" class="bg-slate-50 border-none rounded-2xl px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer">
                                <option value="all">All Roles</option>
                                ${config.roles.map(r => `<option value="${r}" ${rosterFilters.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                            <select onchange="window.updateRosterFilter('status', this.value)" class="bg-slate-50 border-none rounded-2xl px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer">
                                <option value="all">All Status</option>
                                <option value="Hired" ${rosterFilters.status === 'Hired' ? 'selected' : ''}>Hired</option>
                                <option value="Hiring" ${rosterFilters.status === 'Hiring' ? 'selected' : ''}>Hiring</option>
                                <option value="Open" ${rosterFilters.status === 'Open' ? 'selected' : ''}>Open</option>
                                <option value="Resigned" ${rosterFilters.status === 'Resigned' ? 'selected' : ''}>Resigned</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap items-center gap-4">
                            <select onchange="window.updateRosterFilter('tribe', this.value)" class="bg-slate-50 border-none rounded-2xl px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer">
                                <option value="all">All Tribes</option>
                                ${tribes.map(t => `<option value="${t.name}" ${rosterFilters.tribe === t.name ? 'selected' : ''}>${t.name}</option>`).join('')}
                            </select>
                            <select onchange="window.updateRosterFilter('squad', this.value)" class="bg-slate-50 border-none rounded-2xl px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer">
                                <option value="all">All Squads</option>
                                ${[...new Set(tribes.flatMap(t => t.squads || []))].map(s => `<option value="${s}" ${rosterFilters.squad === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <div class="flex items-center gap-2 bg-slate-50 rounded-2xl px-6 py-4">
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Sort:</span>
                                <select onchange="window.updateRosterFilter('sortBy', this.value)" class="bg-transparent border-none text-[10px] font-black uppercase tracking-widest cursor-pointer p-0">
                                    <option value="name" ${rosterFilters.sortBy === 'name' ? 'selected' : ''}>Name</option>
                                    <option value="role" ${rosterFilters.sortBy === 'role' ? 'selected' : ''}>Role</option>
                                    <option value="tribe" ${rosterFilters.sortBy === 'tribe' ? 'selected' : ''}>Tribe</option>
                                    <option value="squad" ${rosterFilters.sortBy === 'squad' ? 'selected' : ''}>Squad</option>
                                    <option value="status" ${rosterFilters.sortBy === 'status' ? 'selected' : ''}>Status</option>
                                </select>
                                <button onclick="window.toggleRosterSort()" class="text-slate-400 hover:text-slate-900 transition-colors">
                                    <i class="fa-solid ${rosterFilters.sortOrder === 'asc' ? 'fa-arrow-down-a-z' : 'fa-arrow-up-z-a'} text-sm" id="roster-sort-icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-sm text-slate-500 font-medium">
                            <i class="fa-solid fa-info-circle text-[#ff5a00] mr-2"></i>
                            Click any row to edit details
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-sm text-slate-500 font-medium">
                            <i class="fa-solid fa-info-circle text-[#ff5a00] mr-2"></i>
                            Select people using checkboxes for bulk updates, or click any row to edit individually
                        </p>
                    </div>
                    
                    <div class="overflow-x-auto no-scrollbar">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[12px] font-black text-slate-400 uppercase tracking-[0.25em] border-b border-slate-50">
                                    <th class="pb-10 px-4 w-12">
                                        <input type="checkbox" 
                                            ${selectedRosterIds.size === filtered.length && filtered.length > 0 ? 'checked' : ''}
                                            onchange="window.toggleAllRosterSelection()" 
                                            class="w-5 h-5 rounded border-2 border-slate-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                    </th>
                                    <th class="pb-10 px-4">Name</th>
                                    <th class="pb-10">Role</th>
                                    <th class="pb-10">Level</th>
                                    <th class="pb-10">Tribe / Squad</th>
                                    <th class="pb-10 text-right px-4">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filtered.map(p => `
                                    <tr class="hover:bg-slate-50 text-sm border-b border-slate-50 transition-colors">
                                        <td class="py-6 px-4" onclick="event.stopPropagation()">
                                            <input type="checkbox" 
                                                ${selectedRosterIds.has(p.id) ? 'checked' : ''}
                                                onchange="window.toggleRosterSelection('${p.id}')" 
                                                class="w-5 h-5 rounded border-2 border-slate-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                        </td>
                                        <td class="py-6 px-4 cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                            <div class="font-bold text-slate-800">${p.name}</div>
                                            ${p.leadershipTitle ? `<div class="text-[8px] font-black uppercase text-indigo-500 mt-1">${p.leadershipTitle}</div>` : ''}
                                        </td>
                                        <td class="py-6 cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                            <span class="px-3 py-1 rounded-xl text-[10px] font-black uppercase ${getRoleColorClass(p.role)}">${p.role}</span>
                                        </td>
                                        <td class="py-6 cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                            <span class="font-mono text-xs text-slate-600">${p.level || 'N/A'}</span>
                                        </td>
                                        <td class="py-6 cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                            <div class="text-sm font-bold text-slate-700">${p.tribe || 'N/A'} / ${p.squad || 'N/A'}</div>
                                        </td>
                                        <td class="py-6 text-right px-4 cursor-pointer" onclick="window.openRosterEditModal('${p.id}')">
                                            <span class="text-[10px] font-black uppercase ${p.status === 'Hired' ? 'text-emerald-500' : p.status === 'Hiring' ? 'text-amber-500' : p.status === 'Resigned' ? 'text-slate-400' : 'text-slate-400'}">${p.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex items-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                <span class="font-bold text-slate-700">${hiredCount} Hired</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                <span class="font-bold text-slate-700">${openCount} Open</span>
                            </div>
                            ${resignedCount > 0 ? `
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                                <span class="font-bold text-slate-400">${resignedCount} Resigned</span>
                            </div>
                            ` : ''}
                            <div class="h-4 w-px bg-slate-200"></div>
                            <span class="text-slate-500 font-medium">${filtered.length} Total</span>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHeaderStats = () => {
            const activePersonnel = filterActivePersonnel(personnel);
            const filled = activePersonnel.filter(p => p.status === 'Hired').length;
            const goal = config.strategicGoal || 1;
            const stats = { 'stat-filled': filled, 'stat-capacity': Math.round((filled / goal) * 100) + '%', 'stat-vacancy': activePersonnel.filter(p => p.status !== 'Hired').length, 'stat-goal': goal, 'header-filled-count': filled, 'header-goal-count': goal };
            Object.entries(stats).forEach(([id, val]) => { const el = document.getElementById(id); if (el) el.textContent = val; });
        };

        const refreshDashboard = () => {
            renderHeaderStats();
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            const activeView = document.getElementById(`${activeTab}-view`);
            if (activeView) activeView.classList.remove('hidden');
            document.querySelectorAll('.nav-tab').forEach(el => { 
                el.classList.toggle('active-tab', el.dataset.tab === activeTab); 
                el.classList.toggle('text-slate-400', el.dataset.tab !== activeTab); 
            });
            if (activeTab === 'summary') renderSummary(); 
            if (activeTab === 'tribes') renderTribeList();
            if (activeTab === 'functions') renderFunctionsList();
            if (activeTab === 'roster') renderRoster();
            if (activeTab === 'ai-assistant') renderAIAssistant();
            if (activeTab === 'config') renderConfig();
            if (activeTab === 'squad-manage') renderSquadManage();
            if (activeTab === 'tribe-manage') renderTribeManage();
        };

        // AI Assistant functions
        const renderAIAssistant = () => {
            const container = document.getElementById('ai-assistant-content');
            if (!container) return;
            
            container.innerHTML = `
                <div class="max-w-5xl mx-auto">
                    <!-- Setup Instructions -->
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-[32px] p-8 mb-8">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-amber-500 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-wrench text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-black uppercase text-amber-900 mb-3">Setup Required</h3>
                                <p class="text-sm text-amber-800 mb-4 leading-relaxed">
                                    This AI Assistant feature requires deployment with a backend server and Anthropic API key. 
                                    It cannot run directly in this artifact due to browser security restrictions (CORS).
                                </p>
                                
                                <div class="bg-white rounded-2xl p-6 mb-4">
                                    <h4 class="text-xs font-black uppercase text-slate-900 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-list-ol text-amber-600"></i>
                                        Setup Steps
                                    </h4>
                                    <ol class="space-y-3 text-sm text-slate-700">
                                        <li class="flex gap-3">
                                            <span class="bg-amber-100 text-amber-900 w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0">1</span>
                                            <span><strong>Get an API Key:</strong> Sign up at <a href="https://console.anthropic.com" target="_blank" class="text-indigo-600 hover:underline font-semibold">console.anthropic.com</a> and create an API key</span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="bg-amber-100 text-amber-900 w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0">2</span>
                                            <span><strong>Deploy Backend:</strong> Create a simple Node.js/Python backend server that proxies requests to the Anthropic API</span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="bg-amber-100 text-amber-900 w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0">3</span>
                                            <span><strong>Update Code:</strong> Change the API endpoint in <code class="bg-slate-100 px-2 py-1 rounded text-xs">handleChatSubmit()</code> to point to your backend server</span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="bg-amber-100 text-amber-900 w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0">4</span>
                                            <span><strong>Add API Key:</strong> Store your API key securely in environment variables on your backend (never in frontend code)</span>
                                        </li>
                                    </ol>
                                </div>
                                
                                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4">
                                    <h4 class="text-xs font-black uppercase text-indigo-900 mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-code text-indigo-600"></i>
                                        Example Backend (Node.js)
                                    </h4>
                                    <pre class="bg-slate-900 text-slate-100 p-4 rounded-lg text-xs overflow-x-auto"><code>// server.js
const express = require('express');
const app = express();

app.post('/api/chat', async (req, res) => {
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': process.env.ANTHROPIC_API_KEY, // Your API key
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify(req.body)
  });
  const data = await response.json();
  res.json(data);
});

app.listen(3000);</code></pre>
                                </div>
                                
                                <div class="mt-4 flex gap-3">
                                    <a href="https://docs.anthropic.com/en/api/getting-started" target="_blank" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-xs font-black uppercase hover:bg-indigo-700 transition-colors inline-flex items-center gap-2">
                                        <i class="fa-solid fa-book"></i>
                                        API Documentation
                                    </a>
                                    <a href="https://console.anthropic.com" target="_blank" class="bg-white border-2 border-amber-300 text-amber-900 px-6 py-3 rounded-xl text-xs font-black uppercase hover:bg-amber-50 transition-colors inline-flex items-center gap-2">
                                        <i class="fa-solid fa-key"></i>
                                        Get API Key
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm mb-8">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                <i class="fa-solid fa-robot text-white text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-900">AI Assistant</h2>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">Ask questions about your organization</p>
                            </div>
                        </div>
                        
                        <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-6 mb-6">
                            <p class="text-sm text-indigo-900 font-medium mb-3">Example questions you can ask:</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <button onclick="window.askAI('How many people are working in Engineering?')" class="text-left bg-white hover:bg-indigo-100 transition-colors px-4 py-3 rounded-xl text-xs font-medium text-indigo-700 border border-indigo-200">
                                    "How many people are working in Engineering?"
                                </button>
                                <button onclick="window.askAI('What is the ratio of PM to Eng in Product tribe?')" class="text-left bg-white hover:bg-indigo-100 transition-colors px-4 py-3 rounded-xl text-xs font-medium text-indigo-700 border border-indigo-200">
                                    "What is the ratio of PM to Eng in Product tribe?"
                                </button>
                                <button onclick="window.askAI('How many open positions do we have?')" class="text-left bg-white hover:bg-indigo-100 transition-colors px-4 py-3 rounded-xl text-xs font-medium text-indigo-700 border border-indigo-200">
                                    "How many open positions do we have?"
                                </button>
                                <button onclick="window.askAI('What is our current IC to Manager ratio?')" class="text-left bg-white hover:bg-indigo-100 transition-colors px-4 py-3 rounded-xl text-xs font-medium text-indigo-700 border border-indigo-200">
                                    "What is our current IC to Manager ratio?"
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chat-messages" class="space-y-6 mb-6 max-h-[600px] overflow-y-auto">
                        ${chatMessages.map((msg, idx) => `
                            <div class="${msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'}">
                                <div class="${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200'} rounded-2xl px-6 py-4 max-w-3xl ${msg.role === 'assistant' ? 'shadow-sm' : ''}">
                                    ${msg.role === 'assistant' ? '<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-robot text-indigo-600"></i><span class="text-[10px] font-black text-slate-400 uppercase">AI Assistant</span></div>' : ''}
                                    <div class="text-sm ${msg.role === 'user' ? 'text-white' : 'text-slate-700'}" style="white-space: pre-wrap;">${msg.content}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${isChatLoading ? `
                            <div class="flex justify-start">
                                <div class="bg-white border border-slate-200 rounded-2xl px-6 py-4 max-w-3xl shadow-sm">
                                    <div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-robot text-indigo-600"></i><span class="text-[10px] font-black text-slate-400 uppercase">AI Assistant</span></div>
                                    <div class="flex gap-2">
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Input Area -->
                    <div class="bg-white rounded-[48px] p-6 border border-slate-100 shadow-lg sticky bottom-6">
                        <form onsubmit="window.handleChatSubmit(event)" class="flex gap-4">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Ask a question about your organization..."
                                class="flex-1 bg-slate-50 border-none rounded-2xl px-6 py-4 text-sm font-medium focus:ring-2 focus:ring-indigo-500"
                                ${isChatLoading ? 'disabled' : ''}
                            >
                            <button 
                                type="submit" 
                                class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                ${isChatLoading ? 'disabled' : ''}
                            >
                                <i class="fa-solid fa-paper-plane"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            `;
            
            // Scroll to bottom
            setTimeout(() => {
                const chatContainer = document.getElementById('chat-messages');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 100);
        };

        // Prepare organization data context for AI
        const getOrgContext = () => {
            const activePersonnel = filterActivePersonnel(personnel);
            const hired = activePersonnel.filter(p => p.status === 'Hired');
            
            // Get counts by tribe
            const tribeData = tribes.filter(t => !config.excludedTribes.includes(t.name)).map(t => {
                const tribePersonnel = hired.filter(p => p.tribe === t.name);
                const roleCounts = getRoleCounts(tribePersonnel);
                return {
                    name: t.name,
                    category: t.category,
                    total: tribePersonnel.length,
                    roles: roleCounts,
                    squads: (t.squads || []).map(sq => ({
                        name: sq,
                        total: hired.filter(p => p.tribe === t.name && p.squad === sq).length
                    }))
                };
            });
            
            // Get overall stats
            const totalCounts = getRoleCounts(hired);
            const mgrRatio = getManagerRatio(hired);
            const openCount = activePersonnel.filter(p => p.status === 'Open').length;
            const hiringCount = activePersonnel.filter(p => p.status === 'Hiring').length;
            
            return {
                totalEmployees: hired.length,
                openPositions: openCount,
                hiringInProgress: hiringCount,
                roleCounts: {
                    eng: totalCounts.eng,
                    pm: totalCounts.pm,
                    pd: totalCounts.pd,
                    data: totalCounts.da
                },
                managerRatio: {
                    ics: mgrRatio.ics,
                    managers: mgrRatio.managers,
                    ratio: mgrRatio.ratio
                },
                tribes: tribeData
            };
        };

        // Handle chat submit
        window.handleChatSubmit = async (event) => {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const question = input.value.trim();
            if (!question || isChatLoading) return;
            
            // Add user message
            chatMessages.push({ role: 'user', content: question });
            input.value = '';
            isChatLoading = true;
            renderAIAssistant();
            
            try {
                const orgContext = getOrgContext();
                
                // ⚠️ DEPLOYMENT REQUIRED: This will fail due to CORS restrictions
                // To make this work:
                // 1. Create a backend server (Node.js/Python/etc)
                // 2. Change this URL to YOUR backend endpoint (e.g., 'https://your-domain.com/api/chat')
                // 3. Add your Anthropic API key to backend environment variables
                // 4. Backend should proxy this request to api.anthropic.com with your API key
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // NOTE: API key should NEVER be in frontend code
                        // It should be in your backend server's environment variables
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: `You are an AI assistant helping analyze organization data. You have access to the following organization information:

${JSON.stringify(orgContext, null, 2)}

Answer questions about this organization data accurately and concisely. Use the data provided to give specific numbers and insights. Format your responses clearly.`,
                        messages: chatMessages.map(msg => ({
                            role: msg.role,
                            content: msg.content
                        }))
                    })
                });
                
                const data = await response.json();
                const assistantMessage = data.content[0].text;
                
                chatMessages.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                console.error('AI Error:', error);
                chatMessages.push({ 
                    role: 'assistant', 
                    content: 'Sorry, I encountered an error processing your request. Please try again.' 
                });
            }
            
            isChatLoading = false;
            renderAIAssistant();
        };

        // Quick ask function
        window.askAI = (question) => {
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = question;
                input.focus();
            }
        };

        const renderConfig = () => {
            const container = document.getElementById('config-view-content');
            if (!container) return;
            
            const currentUserEmail = user?.email || '';
            const isCurrentUserAdmin = accessControl.admins.includes(currentUserEmail);
            
            container.innerHTML = `
                <div class="grid lg:grid-cols-3 gap-10">
                    <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm">
                        <h2 class="text-3xl font-black uppercase mb-10 text-slate-900">Global Strategy</h2>
                        <div class="space-y-12">
                            <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Global FTE Goal</label><input id="config-goal-input" type="number" value="${config.strategicGoal}" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 text-2xl font-black" onchange="window.updateConfig('strategicGoal', this.value)"></div>
                            <div><h4 class="text-[11px] font-black uppercase mb-6 tracking-widest text-indigo-500">Ratio Targets (Eng : X)</h4><div class="grid grid-cols-1 sm:grid-cols-3 gap-6">${Object.entries(config.ratios).map(([key, data]) => `<div><label class="text-[9px] font-black text-slate-400 uppercase block mb-2">${data.label}</label><div class="flex gap-2"><input type="number" placeholder="Min" value="${data.min}" class="w-1/2 bg-slate-50 border-none rounded-xl px-4 py-3 font-black text-sm" onchange="window.updateNestedConfig('ratios', '${key}', 'min', this.value)"><input type="number" placeholder="Max" value="${data.max}" class="w-1/2 bg-slate-50 border-none rounded-xl px-4 py-3 font-black text-sm" onchange="window.updateNestedConfig('ratios', '${key}', 'max', this.value)"></div></div>`).join('')}</div></div>
                            <div><h4 class="text-[11px] font-black uppercase mb-6 tracking-widest text-emerald-500">Composition Mix (%)</h4><div class="grid grid-cols-2 sm:grid-cols-4 gap-6">${Object.entries(config.compositions).map(([key, data]) => `<div><label class="text-[9px] font-black text-slate-400 uppercase block mb-2">${data.label}</label><input type="number" value="${data.val}" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 font-black text-sm" onchange="window.updateNestedConfig('compositions', '${key}', 'val', this.value)"></div>`).join('')}</div></div>
                            <div class="pt-8 border-t border-slate-50">
                                <h4 class="text-[11px] font-black uppercase mb-6 tracking-widest">Job Schema</h4>
                                <div class="space-y-8">
                                    <div><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-indigo-500 uppercase">Leadership Titles</p><button onclick="window.addConfigItem('leadershipTitles')" class="text-indigo-600 text-[10px] font-black">ADD</button></div><div class="flex flex-wrap gap-2">${config.leadershipTitles.map(r => `<span class="bg-[#ff5a00] text-white px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2">${r}<i onclick="window.removeConfigItem('leadershipTitles', '${r}')" class="fa-solid fa-times cursor-pointer opacity-40 hover:opacity-100"></i></span>`).join('')}</div></div>
                                    
                                    <div><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-slate-900 uppercase">Tribe Categories</p><button onclick="window.addConfigItem('categories')" class="text-indigo-600 text-[10px] font-black">ADD</button></div><div class="flex flex-wrap gap-2">${(config.categories || []).map(c => `<span class="bg-[#ff5a00] text-white px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2">${c}<i onclick="window.removeConfigItem('categories', '${c}')" class="fa-solid fa-times cursor-pointer opacity-40 hover:opacity-100"></i></span>`).join('')}</div></div>

                                    <div><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-slate-900 uppercase">Job Families</p><button onclick="window.addConfigItem('roles')" class="text-indigo-600 text-[10px] font-black">ADD</button></div><div class="flex flex-wrap gap-2">${config.roles.map(r => `<span class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2">${r}<i onclick="window.removeConfigItem('roles', '${r}')" class="fa-solid fa-times cursor-pointer opacity-40 hover:opacity-100"></i></span>`).join('')}</div></div>
                                    <div><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-slate-500 uppercase">Seniority Levels</p><button onclick="window.addConfigItem('levels')" class="text-indigo-600 text-[10px] font-black">ADD</button></div><div class="flex flex-wrap gap-2">${config.levels.map(l => `<span class="bg-slate-100 text-slate-500 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2">${l}<i onclick="window.removeConfigItem('levels', '${l}')" class="fa-solid fa-times cursor-pointer opacity-40 hover:opacity-100"></i></span>`).join('')}</div></div>
                                    
                                    <div class="pt-8 border-t border-slate-50">
                                        <div class="mb-3">
                                            <p class="text-[10px] font-black text-red-500 uppercase mb-1">Excluded Tribes</p>
                                            <p class="text-[9px] text-slate-400">Hidden from all counts, ratios & stats (like Resigned)</p>
                                        </div>
                                        <select onchange="window.toggleExcludedTribe(this.value); this.value='';" class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 text-sm font-bold mb-3">
                                            <option value="">Select tribe to exclude/include...</option>
                                            ${tribes.map(t => `<option value="${t.name}">${t.name} ${(config.excludedTribes || []).includes(t.name) ? '✓ EXCLUDED' : ''}</option>`).join('')}
                                        </select>
                                        <div class="flex flex-wrap gap-2">
                                            ${(config.excludedTribes || []).map(tribeName => `<span class="bg-red-50 text-red-600 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2">${tribeName}<i onclick="window.toggleExcludedTribe('${tribeName}')" class="fa-solid fa-times cursor-pointer opacity-40 hover:opacity-100"></i></span>`).join('')}
                                            ${(config.excludedTribes || []).length === 0 ? '<p class="text-[9px] text-slate-300 italic">No tribes excluded</p>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm">
                        <div class="mb-10">
                          <h2 class="text-3xl font-black uppercase text-slate-900 mb-6">Organization Tree</h2>
                          <div class="flex gap-3">
                            <button onclick="window.normalizeTribeCategories({ auto: false })" class="bg-white border border-slate-200 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:bg-slate-50 transition-colors shadow-sm">Sync categories</button>
                            <button onclick="window.addTribe()" class="bg-[#ff5a00] text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest">New Tribe</button>
                          </div>
                        </div>
                        <div class="space-y-6">
                            ${tribes.map((t, tribeIndex) => `
                                <div class="bg-slate-50 p-8 rounded-[32px] border border-slate-100">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex items-start gap-3">
                                            <!-- Tribe Up/Down Arrows -->
                                            <div class="flex flex-col gap-1 pt-1">
                                                <button onclick="window.moveTribeUp('${t.id}')" class="w-6 h-6 rounded flex items-center justify-center text-slate-300 hover:text-[#ff5a00] hover:bg-white transition-all ${tribeIndex === 0 ? 'opacity-20 cursor-not-allowed' : ''}" ${tribeIndex === 0 ? 'disabled' : ''}>
                                                    <i class="fa-solid fa-chevron-up text-xs"></i>
                                                </button>
                                                <button onclick="window.moveTribeDown('${t.id}')" class="w-6 h-6 rounded flex items-center justify-center text-slate-300 hover:text-[#ff5a00] hover:bg-white transition-all ${tribeIndex === tribes.length - 1 ? 'opacity-20 cursor-not-allowed' : ''}" ${tribeIndex === tribes.length - 1 ? 'disabled' : ''}>
                                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                                </button>
                                            </div>
                                            <div>
                                                <input type="text" value="${t.name}" onchange="window.updateTribeName('${t.id}', '${t.name}', this.value)" class="bg-transparent border-none p-0 focus:ring-0 text-lg font-black uppercase text-slate-900 w-full max-w-[200px] mb-2">
                                                <select onchange="window.updateTribeField('${t.id}', 'category', this.value)" class="bg-white border-slate-200 rounded-lg text-[8px] font-black uppercase text-indigo-500 px-2 py-1 cursor-pointer">
                                                    ${(config.categories || ["Unassigned"]).map(cat => `<option value="${cat}" ${t.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="flex gap-4">
                                            <button onclick="window.addSquad('${t.id}', ${JSON.stringify(t.squads || []).replace(/"/g, '&quot;')})" class="text-[10px] font-black text-indigo-600">ADD SQUAD</button>
                                            <button onclick="window.deleteTribe('${t.id}')" class="text-red-400 hover:scale-110 transition-transform"><i class="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2">${(t.squads || []).map((s, squadIndex) => `<span class="bg-white border border-slate-100 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase flex items-center gap-2 shadow-sm">
                                        <!-- Squad Up/Down Arrows -->
                                        <div class="flex gap-0.5">
                                            <button onclick="window.moveSquadUpInTribe('${t.id}', '${s}')" class="w-4 h-4 rounded flex items-center justify-center text-slate-200 hover:text-[#ff5a00] transition-colors ${squadIndex === 0 ? 'opacity-20 cursor-not-allowed' : ''}" ${squadIndex === 0 ? 'disabled' : ''}>
                                                <i class="fa-solid fa-chevron-up text-[8px]"></i>
                                            </button>
                                            <button onclick="window.moveSquadDownInTribe('${t.id}', '${s}')" class="w-4 h-4 rounded flex items-center justify-center text-slate-200 hover:text-[#ff5a00] transition-colors ${squadIndex === (t.squads?.length || 0) - 1 ? 'opacity-20 cursor-not-allowed' : ''}" ${squadIndex === (t.squads?.length || 0) - 1 ? 'disabled' : ''}>
                                                <i class="fa-solid fa-chevron-down text-[8px]"></i>
                                            </button>
                                        </div>
                                        <input type="text" value="${s}" onchange="window.updateSquadName('${t.id}', '${t.name}', '${s}', this.value, ${JSON.stringify(t.squads || []).replace(/"/g, '&quot;')})" class="bg-transparent border-none p-0 focus:ring-0 text-[10px] font-black uppercase text-slate-700 w-24">
                                        <div class="flex items-center gap-2 ml-1">
                                            <i onclick="window.moveSquad('${t.id}', '${t.name}', '${s}', ${JSON.stringify(t.squads || []).replace(/"/g, '&quot;')})" class="fa-solid fa-right-left cursor-pointer opacity-20 hover:opacity-100 hover:text-[#ff5a00]"></i>
                                            <i onclick="window.deleteSquad('${t.id}', '${s}', ${JSON.stringify(t.squads || []).replace(/"/g, '&quot;')})" class="fa-solid fa-times cursor-pointer opacity-20 hover:opacity-100 hover:text-red-500"></i>
                                        </div>
                                    </span>`).join('')}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Access Control Section -->
                    <div class="bg-white rounded-[48px] p-12 border border-slate-100 shadow-sm">
                        <h2 class="text-3xl font-black uppercase mb-4 text-slate-900">Access Control</h2>
                        <p class="text-sm text-slate-500 mb-8">Manage who can view and edit this workspace</p>
                        
                        <!-- Current User Info -->
                        <div class="mb-8 p-4 rounded-2xl ${isCurrentUserAdmin ? 'bg-emerald-50 border border-emerald-100' : 'bg-blue-50 border border-blue-100'}">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fa-solid fa-user text-xs ${isCurrentUserAdmin ? 'text-emerald-600' : 'text-blue-600'}"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest ${isCurrentUserAdmin ? 'text-emerald-600' : 'text-blue-600'}">You are logged in as</span>
                            </div>
                            <p class="font-bold text-slate-900 text-sm">${currentUserEmail}</p>
                            <span class="inline-block mt-2 px-3 py-1 rounded-full text-[9px] font-black uppercase ${isCurrentUserAdmin ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}">${isCurrentUserAdmin ? 'Admin' : 'Viewer'}</span>
                        </div>

                        <!-- Admins Section -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h4 class="text-[11px] font-black uppercase text-emerald-500 tracking-widest">Admins</h4>
                                    <p class="text-[9px] text-slate-400 mt-1">Full read & write access</p>
                                </div>
                                ${isCurrentUserAdmin ? `<button onclick="window.addAdmin()" class="bg-[#ff5a00] text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest">Add Admin</button>` : ''}
                            </div>
                            <div class="space-y-2">
                                ${accessControl.admins.length === 0 ? `
                                    <div class="text-center py-6 bg-slate-50 rounded-2xl">
                                        <p class="text-xs text-slate-400">No admins configured</p>
                                    </div>
                                ` : accessControl.admins.map(email => `
                                    <div class="flex items-center justify-between p-3 rounded-2xl border border-slate-100 hover:border-emerald-100 bg-slate-50 hover:bg-emerald-50 transition-all">
                                        <div class="flex items-center gap-3 min-w-0">
                                            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0">
                                                <i class="fa-solid fa-shield-halved text-emerald-600 text-xs"></i>
                                            </div>
                                            <span class="font-bold text-slate-700 text-sm truncate">${email}</span>
                                            ${email === currentUserEmail ? `<span class="text-[8px] font-black uppercase text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">You</span>` : ''}
                                        </div>
                                        ${isCurrentUserAdmin && email !== currentUserEmail ? `
                                            <button onclick="window.removeAdmin('${email}')" class="text-slate-300 hover:text-red-500 transition-colors ml-2">
                                                <i class="fa-solid fa-times text-xs"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Viewers Section -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h4 class="text-[11px] font-black uppercase text-blue-500 tracking-widest">Viewers</h4>
                                    <p class="text-[9px] text-slate-400 mt-1">Read-only access</p>
                                </div>
                                ${isCurrentUserAdmin ? `<button onclick="window.addViewer()" class="bg-[#ff5a00] text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest">Add Viewer</button>` : ''}
                            </div>
                            <div class="space-y-2">
                                ${accessControl.viewers.length === 0 ? `
                                    <div class="text-center py-6 bg-slate-50 rounded-2xl">
                                        <p class="text-xs text-slate-400">No viewers configured</p>
                                    </div>
                                ` : accessControl.viewers.map(email => `
                                    <div class="flex items-center justify-between p-3 rounded-2xl border border-slate-100 hover:border-blue-100 bg-slate-50 hover:bg-blue-50 transition-all">
                                        <div class="flex items-center gap-3 min-w-0">
                                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                                                <i class="fa-solid fa-eye text-blue-600 text-xs"></i>
                                            </div>
                                            <span class="font-bold text-slate-700 text-sm truncate">${email}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            ${isCurrentUserAdmin ? `
                                                <button onclick="window.promoteToAdmin('${email}')" class="text-emerald-500 hover:text-emerald-600 transition-colors" title="Promote to admin">
                                                    <i class="fa-solid fa-arrow-up text-xs"></i>
                                                </button>
                                                <button onclick="window.removeViewer('${email}')" class="text-slate-300 hover:text-red-500 transition-colors">
                                                    <i class="fa-solid fa-times text-xs"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Firebase Rules Info -->
                        <div class="mt-8 p-4 rounded-2xl bg-amber-50 border border-amber-100">
                            <div class="flex items-start gap-3">
                                <i class="fa-solid fa-info-circle text-amber-600 text-sm mt-0.5"></i>
                                <div>
                                    <h5 class="text-[10px] font-black uppercase text-amber-700 mb-2">Firebase Security</h5>
                                    <p class="text-[10px] text-amber-700 leading-relaxed">Access is enforced via Firebase Security Rules. Only emails listed above can access this data. Update your Firebase rules to match these lists.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Activity Logs Section -->
                        <div class="mt-8">
                            <h3 class="text-2xl font-black uppercase text-slate-900 mb-4">Activity Logs</h3>
                            <p class="text-sm text-slate-500 mb-6">Last 10 days of changes</p>
                            
                            ${(() => {
                                const tenDaysAgo = new Date();
                                tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
                                
                                const recentLogs = logs.filter(log => {
                                    const logDate = log.timestamp?.toDate?.() || new Date(0);
                                    return logDate >= tenDaysAgo;
                                });

                                const getActionIcon = (action) => {
                                    if (action.includes('Added')) return 'fa-plus-circle text-emerald-500';
                                    if (action.includes('Updated')) return 'fa-edit text-blue-500';
                                    if (action.includes('Deleted')) return 'fa-trash text-red-500';
                                    return 'fa-circle text-slate-400';
                                };

                                const formatTimestamp = (timestamp) => {
                                    if (!timestamp?.toDate) return 'Unknown time';
                                    const date = timestamp.toDate();
                                    const now = new Date();
                                    const diffMs = now - date;
                                    const diffMins = Math.floor(diffMs / 60000);
                                    const diffHours = Math.floor(diffMs / 3600000);
                                    const diffDays = Math.floor(diffMs / 86400000);

                                    if (diffMins < 1) return 'Just now';
                                    if (diffMins < 60) return diffMins + 'm ago';
                                    if (diffHours < 24) return diffHours + 'h ago';
                                    if (diffDays < 10) return diffDays + 'd ago';
                                    return date.toLocaleDateString();
                                };

                                if (recentLogs.length === 0) {
                                    return `
                                        <div class="text-center py-12 bg-slate-50 rounded-2xl">
                                            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
                                                <i class="fa-solid fa-clock-rotate-left text-2xl text-slate-300"></i>
                                            </div>
                                            <h3 class="text-lg font-black text-slate-400 mb-2">No Recent Activity</h3>
                                            <p class="text-slate-400 text-sm">Changes will appear here when you make updates</p>
                                        </div>
                                    `;
                                }

                                return `
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        ${recentLogs.slice(0, 20).map(log => `
                                            <div class="flex items-start gap-3 p-4 rounded-2xl border border-slate-100 hover:border-slate-200 bg-white hover:shadow-sm transition-all">
                                                <div class="flex-shrink-0 w-8 h-8 rounded-xl bg-slate-50 flex items-center justify-center">
                                                    <i class="fa-solid ${getActionIcon(log.action)} text-sm"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-start justify-between gap-4 mb-1">
                                                        <h4 class="font-black text-slate-900 text-xs">${log.action}</h4>
                                                        <span class="text-[10px] font-bold text-slate-400 whitespace-nowrap">${formatTimestamp(log.timestamp)}</span>
                                                    </div>
                                                    <p class="text-xs text-slate-600 font-medium mb-1">${log.details}</p>
                                                    <div class="flex items-center gap-2">
                                                        <i class="fa-solid fa-user text-[9px] text-slate-300"></i>
                                                        <span class="text-[9px] font-bold text-slate-400 uppercase">${log.user || 'System'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                </div>
            `;
        };

        onAuthStateChanged(auth, (u) => { 
            user = u; 
            if (!loginScreen) initDOMElements(); 
            if (user) { 
                loginScreen.classList.add('hidden'); 
                initListeners(); 
            } else { 
                loginScreen.classList.remove('hidden'); 
                appDashboard.classList.add('hidden'); 
                emptyState.classList.add('hidden'); 
            } 
            if (loadingOverlay) loadingOverlay.classList.add('hidden'); 
        });

        window.addEventListener('DOMContentLoaded', () => { 
            initDOMElements(); 
            document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider)); 
            document.getElementById('guest-btn').addEventListener('click', () => signInAnonymously(auth)); 
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth)); 
            document.getElementById('add-entry-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Get selected secondary tribes from multi-select
                const secondarySelect = document.getElementById('modal-secondary-select');
                const selectedSecondary = Array.from(secondarySelect.selectedOptions).map(option => option.value);
                data.secondaryTribes = selectedSecondary.join(','); // Convert to CSV for existing handler
                
                window.addNewHeadcount(data); 
            }); 
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; -webkit-font-smoothing: antialiased; }
        .active-tab { color: #4f46e5; background: #ffffff; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-tab { transition: all 0.3s ease; cursor: pointer; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Multi-select improvements */
        select[multiple] option {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 8px;
            cursor: pointer;
        }
        select[multiple] option:hover {
            background-color: #EEF2FF !important;
        }
        select[multiple] option:checked {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%) !important;
            color: white !important;
            font-weight: 600;
        }
        select[multiple]:focus {
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen text-slate-900 overflow-x-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-[100] hidden">
        <div class="animate-pulse flex flex-col items-center">
            <div class="w-20 h-20 bg-indigo-600 rounded-[32px] mb-8 shadow-2xl flex items-center justify-center text-white text-3xl"><i class="fa-solid fa-layer-group"></i></div>
            <p class="text-[12px] font-black text-slate-400 uppercase tracking-[0.3em]">Synchronizing data...</p>
        </div>
    </div>

    <!-- ENTRY MODAL -->
    <div id="entry-modal" class="fixed inset-0 bg-slate-950/60 backdrop-blur-sm z-[110] flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-xl rounded-[48px] p-12 shadow-2xl animate-in max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-black uppercase text-slate-900">Add Headcount</h2><button onclick="window.closeEntryModal()" class="text-slate-400 hover:text-slate-900"><i class="fa-solid fa-times text-xl"></i></button></div>
            <form id="add-entry-form" class="space-y-6">
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Full Name</label><input name="name" type="text" placeholder="John Doe" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold" required></div>
                <div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Role</label><select name="role" id="modal-role-select" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select></div><div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Level</label><select name="level" id="modal-level-select" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select></div></div>
                <div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-black text-indigo-500 uppercase mb-2 block tracking-widest">Leadership Title <span class="text-[8px] text-slate-400 normal-case ml-1">(Shows in Summary if Hired)</span></label><select name="leadershipTitle" id="modal-ltitle-select" class="w-full bg-indigo-50 border-none rounded-2xl px-6 py-4 font-bold text-indigo-600"></select></div><div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Additional Tribes</label><select name="secondaryTribes" id="modal-secondary-select" multiple class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl px-3 py-2 font-medium text-sm min-h-[60px] focus:border-indigo-400 focus:ring-0 transition-colors"></select><p class="text-[8px] text-slate-400 mt-1"><i class="fa-solid fa-info-circle mr-1"></i>Click to select/unselect</p></div></div>
                <div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Primary Tribe</label><select name="tribe" id="modal-tribe-select" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select></div><div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Squad</label><select name="squad" id="modal-squad-select" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select></div></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Status</label><select name="status" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"><option value="Open" selected>Open (Proposed)</option><option value="Hiring">Hiring (Active)</option><option value="Hired">Hired</option><option value="Resigned">Resigned</option></select></div>
                <div class="flex gap-4 pt-6"><button type="button" onclick="window.closeEntryModal()" class="flex-1 py-4 px-8 rounded-3xl font-black uppercase text-xs text-slate-400 bg-slate-50">Cancel</button><button type="submit" class="flex-[2] py-4 px-8 rounded-3xl font-black uppercase text-xs text-white bg-indigo-600 shadow-xl shadow-orange-100">Create Entry</button></div>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="app-dashboard" class="hidden">
        <nav class="fixed top-0 left-0 w-full bg-white/90 backdrop-blur-xl border-b border-slate-100 h-28 px-12 flex items-center justify-between z-50">
            <div class="flex items-center gap-8">
                <div class="w-14 h-14 bg-indigo-600 rounded-[22px] flex items-center justify-center text-white shadow-2xl shadow-indigo-200"><i class="fa-solid fa-layer-group text-xl"></i></div>
                <div class="hidden lg:block"><h2 class="text-2xl font-black uppercase text-slate-900">Commander</h2><p class="text-[10px] font-black text-slate-400 uppercase mt-2 tracking-widest">Active Strategy • <span id="header-filled-count" class="text-indigo-600">0</span>/<span id="header-goal-count">0</span> Filled</p></div>
            </div>
            <div class="flex items-center gap-3 bg-slate-100/50 p-2 rounded-[24px]">
                <div onclick="window.setTab('summary')" data-tab="summary" class="nav-tab active-tab px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">Summary</div>
                <div onclick="window.setTab('tribes')" data-tab="tribes" class="nav-tab text-slate-400 px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">Tribes</div>
                <div onclick="window.setTab('functions')" data-tab="functions" class="nav-tab text-slate-400 px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">Functions</div>
                <div onclick="window.setTab('roster')" data-tab="roster" class="nav-tab text-slate-400 px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">Roster</div>
                <div onclick="window.setTab('ai-assistant')" data-tab="ai-assistant" class="nav-tab text-slate-400 px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">AI Assistant</div>
                <div onclick="window.setTab('config')" data-tab="config" class="nav-tab text-slate-400 px-8 py-3.5 text-[12px] font-black uppercase tracking-tight">Config</div>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="window.exportToExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-file-excel"></i>
                    Export Excel
                </button>
                <button onclick="window.openEntryModal()" class="bg-[#ff5a00] text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-orange-100">New Entry</button>
                <button id="logout-btn" class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 hover:text-red-500 flex items-center justify-center transition-colors"><i class="fa-solid fa-right-from-bracket text-sm"></i></button>
            </div>
        </nav>

        <main class="pt-40 pb-24 px-12 max-w-[1800px] mx-auto">
            <div id="summary-view" class="tab-view"><div id="summary-container"></div></div>
            <div id="tribes-view" class="tab-view hidden"><div id="tribes-container"></div></div>
            <div id="functions-view" class="tab-view hidden"><div id="functions-container"></div></div>
            <div id="tribe-manage-view" class="tab-view hidden"><div id="tribe-manage-view-content"></div></div>
            <div id="squad-manage-view" class="tab-view hidden"><div id="squad-manage-view-content"></div></div>
            <div id="ai-assistant-view" class="tab-view hidden"><div id="ai-assistant-content"></div></div>
            <div id="config-view" class="tab-view hidden"><div id="config-view-content"></div></div>
            <div id="roster-view" class="tab-view hidden">
                <div id="roster-view-content"></div>
            </div>
        </main>
    </div>

    <!-- COLD START SETUP -->
    <div id="login-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-6 bg-slate-950">
        <div class="max-w-md w-full text-center space-y-16"><div class="inline-flex p-8 rounded-[48px] bg-indigo-600/10 text-indigo-500 border border-indigo-600/10 shadow-2xl"><i class="fa-solid fa-users-gear text-6xl"></i></div><h1 class="text-6xl font-black text-white tracking-tighter leading-[0.9]">HEADCOUNT<br><span class="text-indigo-500">COMMANDER</span></h1><div class="space-y-5"><button id="login-btn" class="w-full py-6 px-10 bg-white text-slate-950 font-black rounded-[28px] flex items-center justify-center gap-5 hover:bg-slate-100 transition-all uppercase text-sm tracking-widest shadow-2xl">Sign in with Google</button><button id="guest-btn" class="w-full py-5 px-8 bg-slate-900 text-slate-400 border border-slate-800 font-black rounded-[28px] hover:text-white transition-all uppercase text-[11px] tracking-[0.3em]">Guest Access</button></div></div>
    </div>
    <div id="empty-state-setup" class="hidden min-h-screen flex flex-col items-center justify-center p-12 bg-[#F8FAFC]">
        <div class="max-w-2xl w-full bg-white rounded-[64px] p-16 border border-slate-100 shadow-2xl text-center"><div class="w-24 h-24 bg-indigo-50 text-indigo-600 rounded-[32px] flex items-center justify-center text-4xl mx-auto mb-10"><i class="fa-solid fa-cloud-upload"></i></div><h2 class="text-4xl font-black uppercase text-slate-900 mb-4 tracking-tighter">Initialize Organization</h2><p class="text-slate-500 font-medium mb-12 text-lg">Upload headcount snapshot (CSV) to begin.</p><label class="block"><span class="bg-[#ff5a00] text-white px-10 py-5 rounded-[28px] text-xs font-black uppercase tracking-widest block text-center cursor-pointer hover:bg-indigo-700 shadow-xl shadow-orange-100">Upload CSV Snapshot</span><input type="file" accept=".csv" onchange="window.handleFileUpload(event)" class="hidden"></label></div>
    </div>

    <!-- ROSTER EDIT MODAL -->
    <div id="roster-edit-modal" class="fixed inset-0 bg-slate-950/60 backdrop-blur-sm z-[110] flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-2xl rounded-[48px] p-12 shadow-2xl animate-in max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-black uppercase text-slate-900">Edit Entry</h2>
                <button onclick="window.closeRosterEditModal()" class="text-slate-400 hover:text-slate-900">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <input type="hidden" id="edit-person-id">
            
            <form class="space-y-6" onsubmit="event.preventDefault(); window.saveRosterEdit();">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Full Name</label>
                    <input id="edit-person-name" type="text" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold" required>
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Role</label>
                        <select id="edit-person-role" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold">
                            <!-- Options populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Level</label>
                        <select id="edit-person-level" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold">
                            <!-- Options populated dynamically from config.levels -->
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Primary Tribe</label>
                        <select id="edit-person-tribe" onchange="window.updateEditSquadOptions(this.value)" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Squad</label>
                        <select id="edit-person-squad" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold"></select>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Status</label>
                    <select id="edit-person-status" class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold">
                        <option value="Open">Open (Proposed)</option>
                        <option value="Hiring">Hiring (Active)</option>
                        <option value="Hired">Hired</option>
                        <option value="Resigned">Resigned</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-indigo-500 uppercase mb-2 block tracking-widest">
                        Leadership Title 
                        <span class="text-[8px] text-slate-400 normal-case ml-2">(Required to show in Summary leadership table)</span>
                    </label>
                    <select id="edit-person-leadership" class="w-full bg-indigo-50 border-none rounded-2xl px-6 py-4 font-bold text-indigo-600">
                        <option value="">No Leadership Role</option>
                        <option value="Tribe Lead">Tribe Lead</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Additional Tribes Covered</label>
                    <select id="edit-person-secondary" multiple class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl px-4 py-3 font-medium text-sm min-h-[120px] focus:border-indigo-400 focus:ring-0 transition-colors">
                        <!-- Options populated dynamically -->
                    </select>
                    <p class="text-[9px] text-slate-400 mt-2"><i class="fa-solid fa-info-circle mr-1"></i>Click to select/unselect. Multiple selections allowed.</p>
                </div>
                
                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="window.deleteRosterEntry()" class="flex-1 py-4 px-8 rounded-3xl font-black uppercase text-xs text-white bg-red-500 hover:bg-red-600">
                        Delete
                    </button>
                    <button type="button" onclick="window.closeRosterEditModal()" class="flex-1 py-4 px-8 rounded-3xl font-black uppercase text-xs text-slate-400 bg-slate-50">
                        Cancel
                    </button>
                    <button type="submit" class="flex-[2] py-4 px-8 rounded-3xl font-black uppercase text-xs text-white bg-indigo-600 shadow-xl shadow-orange-100">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>